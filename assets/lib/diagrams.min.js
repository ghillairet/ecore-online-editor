/*! diagrams 2013-06-30 */
!function(){function a(a){return"function"==typeof a.render?a.render():a}var b=this,c=b.DG={},d=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.__super__=d.prototype,c},e=c.Point=function(a,b){this.x=a,this.y=b};e.prototype.vector=function(a){return e.vector(this,a)},e.prototype.theta=function(a){return e.theta(this,a)},e.prototype.add=function(a){this.x+=a.y,this.y+=a.y},e.prototype.sub=function(a){this.x-=a.x,this.y-=a.y},e.prototype.equals=function(a){return a?this.x===a.x&&this.y===a.y:!1},e.get=function(a){var b;return a&&a.offsetX?b=new e(a.offsetX,a.offsetY):a&&a.layerX&&(b=new e(a.layerX,a.layerY)),b},e.theta=function(a,b){var c=-(b.y-a.y),d=b.x-a.x,e=Math.atan2(c,d);return 0>e&&(e=2*Math.PI+e),{degrees:180*e/Math.PI,radians:e}},e.vector=function(a,b){return{x:b.x-a.x,y:b.y-a.y}};var f=function(a,b,c){return{path:a.path("M"+b.x+" "+b.y+"L"+c.x+" "+c.y),start:b,end:c}},g=function(a,b){var c={x:a.end.x-a.start.x,y:a.end.y-a.start.y},d={x:b.end.x-b.start.x,y:b.end.y-b.start.y},e=c.x*d.y-c.y*d.x,f={x:b.start.x-a.start.x,y:b.start.y-a.start.y},g=f.x*d.y-f.y*d.x,h=f.x*c.y-f.y*c.x;if(0===e||0>g*e||0>h*e)return null;if(e>0){if(g>e||h>e)return null}else if(e>g||e>h)return null;return{x:a.start.x+g*c.x/e,y:a.start.y+g*c.y/e}},h=function(a,b,c){for(var d,e,h={x:c.x,y:c.y},i={x:c.x+c.width,y:c.y},j={x:c.x,y:c.y+c.height},k={x:c.x+c.width,y:c.y+c.height},l=[{p1:h,p2:i},{p1:h,p2:j},{p1:j,p2:k},{p1:k,p2:i}],m=0,n=l.length;n>m;m++)if(d=f(a,l[m].p1,l[m].p2),e=g(b,d),d.path.remove(),e)return e;return null};c.Arrows=Arrows={get:function(a){return"function"==typeof c.Arrows[a]?c.Arrows[a]:c.Arrows.basic},none:function(a){return a||(a=2),{path:["M",a,"0","L",""+-a,"0"],dx:a,dy:a,attr:{opacity:0}}},basic:function(a){return a||(a=4),{path:["M",""+a,"0","L",""+-a,""+-a,"L",""+-a,""+a,"Z"],dx:a,dy:a,attr:{stroke:"black",fill:"black"}}}};var i=[],j=i.slice,k=c.Events={on:function(a,b,c){if(!m(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!m(this,"once",a,[b,c])||!b)return this;var d=this,e=_.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,h,i,j,k;if(!this._events||!m(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;for(g=a?[a]:_.keys(this._events),h=0,i=g.length;i>h;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,k=f.length;k>j;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=j.call(arguments,1);if(!m(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&n(c,b),d&&n(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}},l=/\s+/,m=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(l.test(c)){for(var f=c.split(l),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},n=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},o={listenTo:"on",listenToOnce:"once"};_.each(o,function(a,b){k[b]=function(b,c,d){var e=this._listeners||(this._listeners={}),f=b._listenerId||(b._listenerId=_.uniqueId("l"));return e[f]=b,"object"==typeof c&&(d=this),b[a](c,d,this),this}});var p=function(){this.constructor.call(this,SVG.create("rect")),this.attr(p.style)};p.style={stroke:"#00f","stroke-width":2,fill:"#aaf",opacity:.4},p.prototype=new SVG.Shape,p.mousedown=function(a){return function(b){var c=e.get(b),d=a.selectionBox=a.doc.selectionBox();d.startPosition={x:c.x,y:c.y},d.move(c.x,c.y)}},p.mouseup=function(a){return function(){var b=a.selectionBox;b&&(a.selectNodes({x:b.attr("x"),y:b.attr("y"),width:b.attr("width"),height:b.attr("height")}),b.remove(),delete a.selectionBox)}},p.mousemove=function(a){return function(b){var c,d,f,g,h=0,i=0,j=a.selectionBox;j&&(g=j.startPosition,c=e.get(b),d=c.x-g.x,f=c.y-g.y,0>d&&(h=d,d=-1*d),0>f&&(i=f,f=-1*f),j.transform({x:h,y:i}),j.size(d,f))}},SVG.extend(SVG.Container,{selectionBox:function(a){return this.put(new p(a))}});var q=c.Diagram=function(a,b){this.doc=new SVG.Doc(a),this.shapes=[],this.edges=[],this.selected=[],this.wrapper=this.doc.rect().attr(q.figure),this.wrapper.click(q.delSelection(this)),this.wrapper.on("mousedown",p.mousedown(this)),SVG.on(window,"mouseup",p.mouseup(this)),SVG.on(window,"mousemove",p.mousemove(this)),this.on("click",this.deselect),this.initialize.apply(this,[b])};q.extend=d,q.figure={fill:"#fff","fill-opacity":0,stroke:"none",width:"100%",height:"100%"},q.addElement=function(a){return function(b){b instanceof J||b instanceof K?(b.parent=a,b.isRoot=!0,a.shapes.push(b),b.on("select",q.addSelection(a,b))):arg instanceof C&&(b.parent=a,a.edges.push(b),b.on("select",q.addSelection(a,b)))}},q.addSelection=function(a,b){return function(){a.select(b)}},q.delSelection=function(a){return function(){a.deselect()}},_.extend(c.Diagram.prototype,k,{initialize:function(){},eachShape:function(a,b){return _.each(this.shapes,a,b||this),this},eachEdge:function(a,b){return _.each(this.edges,a,b||this),this},findShape:function(a,b){return _.find(this.shapes,a,b)},add:function(){return _.each(arguments,q.addElement(this)),this},render:function(){return this.eachShape(function(a){a.render()}).eachEdge(function(a){a.render()})},remove:function(a){a instanceof C?this.edges=_.without(this.edges,a):this.shapes=_.without(this.shapes,a)},select:function(a){var b=_.find(this.selected,function(b){return b===a});b||this.selected.push(a)},deselect:function(a){return a?(a.deselect(),this.selected=_.without(this.selected,a)):(_.each(this.selected,function(a){a.deselect()}),this.selected.length=0),this},selectNodes:function(a){this.eachShape(function(b){b.isInside(a)&&b.select()},this)}});var r=c.GridLayout=function(a,b){if(!a)throw Error("Shape is not defined");b=b||{},this._shape=a,this._columns=b.columns||1,this._rows=b.rows||0,this.marginHeight=b.marginHeight||0,this.marginWidth=b.marginWidth||0,this.vgap=b.vgap||0,this.hgap=b.hgap||0};r.prototype.columns=function(){var a=this._shape.children;return this._rows>0?Math.floor((a.length+this._rows-1)/this._rows):this._columns},r.prototype.size=function(){return this._shape.children.length?(this.rows=this.createRows(),this.bounds=this.computeSize(),this.bounds):void 0},r.prototype.computeSize=function(){var a=_.max(this.rows||[],function(a){return a.width}),b=_.reduce(this.rows||[],function(a,b){return a+b.height},0),c=2*this.marginWidth+a.width+this.hgap*(a.cells.length-1);b=b+(this.rows.length-1)*this.vgap+2*this.marginHeight;var d=this._shape.figure.bbox();return c=Math.max(d.width,c),b=Math.max(d.height,b),{height:b,width:c}};var s=function(a){return a.layout?a.layout.bounds||a.figure.bbox():a.figure.bbox()},t=function(a,b){var c,d,e,f,g=0,h=1,i=a.length,j=[],k={width:0,height:0,cells:[]};for(i&&j.push(k);i>g;g++,h++)f=a[g],e=new v({shape:f}),e.size=s(f),c&&(e.previous=c,c.next=e),c=e,k.cells.push(e),h>=b&&(g!=i-1&&(d={previous:k,width:0,height:0,cells:[]},k.next=d,k=d,j.push(k)),h=0);return j},u=function(a,b){for(var c,d,e=[],f=0,g=a.length;b>f;f++)for(e.push([]),c=0;g>c;c++)d=a[c].cells[f],d&&e[f].push(d);return e};r.prototype.createRows=function(){var a=this._shape.children,b=t(a,this.columns());_.each(u(b,this.columns()),function(a){_.each(a,function(a){a.height=a.size.height})});var c=function(a){var b=function(b){b.width=b.size.width,a.width+=b.width};_.each(a.cells,b,this);var c=null;a.cells.length&&(c=_.max(a.cells,function(a){return a.height})),a.height=c?c.height:0};return _.each(b,c,this),b},r.prototype.layout=function(){var a=this._shape.figure,b=s(this._shape),c=a.x()+this.marginWidth,d=c,e=a.y()+this.marginHeight,f=this.hgap,g=this.vgap,h=this.marginWidth,i=this.marginHeight,j=function(a){var c=_.reduce(a,function(a,b){return b.shape.gridData&&b.shape.gridData.grabExcessVerticalSpace?a:a+b.size.height},0),d=_.reduce(a,function(a,b){return b.shape.gridData&&b.shape.gridData.grabExcessVerticalSpace?a+1:a},0),e=g*(a.length-1),f=b.height-2*i-e,h=(f-c)/d;return h},k=function(a){var c=_.reduce(a.cells,function(a,b){return b.shape.gridData&&b.shape.gridData.grabExcessHorizontalSpace?a:a+b.size.width},0),d=_.reduce(a.cells,function(a,b){return b.shape.gridData&&b.shape.gridData.grabExcessHorizontalSpace?a+1:a},0),e=f*(a.cells.length-1),g=b.width-2*h-e,i=(g-c)/d;return i},l=function(a){var b=k(a),h=function(a){a.x=d,a.y=e,a.width=a.shape.gridData&&a.shape.gridData.grabExcessHorizontalSpace?b:a.size.width,d+=a.width+f};_.each(a.cells,h),e+=a.height+g,d=c},m=function(a){a.layout()},n=function(a){_.each(a.cells,m)};_.each(u(this.rows||[],this.columns()),function(a){var b=j(a);_.each(a,function(a){a.height=a.shape.gridData&&a.shape.gridData.grabExcessVerticalSpace?b:a.size.height})}),_.each(this.rows||[],l),_.each(this.rows||[],n),_.each(this._shape.children||[],function(a){a.layout&&a.layout.layout()})};var v=c.GridCell=function(a){this.shape=a.shape,this.width=0,this.height=0};v.prototype.layout=function(){var a=this.shape.gridData,b=this.shape.figure.bbox();x=this.x,y=this.y,width=b.width,height=b.height,a?(this.shape.figure.move(x,y),"fill"===a.horizontalAlignment&&this.shape.figure.attr({width:this.width,height:this.height})):this.shape.figure.move(x,y)};var w=c.GridData=function(a){var b=a||{};this.verticalAlignment=w.getVerticalAlignment(b),this.horizontalAlignment=w.getHorizontalAlignment(b),this.grabExcessVerticalSpace=b.grabExcessVerticalSpace||!1,this.grabExcessHorizontalSpace=b.grabExcessHorizontalSpace||!1,this.verticalSpan=b.verticalSpan||1,this.horizontalSpan=b.horizontalSpan||1};w.alignments=["center","fill","beginning","end"],w.getAlignment=function(a,b){var c=a[b+"Alignment"];return _.contains(w.alignments,c)?c:null},w.getVerticalAlignment=function(a){return w.getAlignment(a,"vertical")||"center"},w.getHorizontalAlignment=function(a){return w.getAlignment(a,"horizontal")||"beginning"};var z=c.Layout={};z.create=function(a,b){var c=b.layout;if(!a||!c||!c.type)return null;switch(c.type){case"grid":return new r(a,c);default:return null}};var A=c.Figure={};A.create=function(a,b){if(!a)throw new Exception("Shape is missing");return a.diagram().doc.figure(a,b)};var B=function(a,b){var c,d=b.type;if(d&&"function"==typeof a[d])switch(d){case"rect":c=a.rect(b.width,b.height);break;case"circle":c=a.circle(b.r);break;case"ellipse":c=a.ellipse(b.rx,b.ry);break;case"polygon":c=a.polygon(b.coordinates);break;case"text":c=a.text(b.text);break;case"image":c=a.image(b.path,b.width,b.height);break;default:c=null}return c&&c.attr(b),c};SVG.extend(SVG.Container,{figure:function(a,b){var c=b||{},d=a.attributes||{},e=B(this,c);e.attributes=_.clone(c),e.shape=a,e.connectAnchors=[],d.width&&(e.attributes.width=d.width),d.height&&(e.attributes.height=d.height),d.text&&(e.attributes.text=d.text),e.attr(e.attributes),d.x&&d.y&&e.move(d.x,d.y);var f=e.bbox();return e.attributes.min={},e.attributes.min.width=f.width,e.attributes.min.height=f.height,e}}),SVG.extend(SVG.Shape,{remove:function(){return this.hideDeleteAction(),this.deselect(),SVG.Element.prototype.remove.apply(this,arguments)},minimumSize:function(){return this.attributes.min},showConnectAnchors:function(){var a=this.shape;return this.hasConnectAnchors?this:(this.connectAnchors.length?_.each(this.connectAnchors,function(a){a.render()}):this.connectAnchors=_.map(a.anchors,I.create(a),this),this.hasConnectAnchors=!0,this)},hideConnectAnchors:function(){return this.hasConnectAnchors?(_.each(this.connectAnchors,function(a){a.remove()}),this.connectAnchors.length=0,this.hasConnectAnchors=!1,this):this},select:function(){if(this.isSelected)return this;var a=this.shape;return this.previous={},this.previous.stroke=this.attr("stroke"),this.previous["stroke-width"]=this.attr("stroke-width"),this.attr({stroke:"#6599FF","stroke-width":2}),this.selectAnchors=_.map(H.positions,H.create(a),this),this.showDeleteAction(this.shape),this.isSelected=!0,this},deselect:function(){return this.isSelected?(this.attr({stroke:this.previous.stroke,"stroke-width":this.previous["stroke-width"]}),_.each(this.selectAnchors,function(a){a.remove()}),this.hideConnectAnchors(),this.hideDeleteAction(),this.isSelected=!1,this):this},showDeleteAction:function(){var a=this.bbox(),b=this.shape,c=b.diagram().doc;return this.deleteAnchor=c.circle(12).attr({fill:"red",stroke:"#6599FF"}),this.deleteAnchor.move(a.x+a.width-22,a.y-6),this.deleteAnchor.click(function(){b.remove()}),this},hideDeleteAction:function(){return this.deleteAnchor&&(this.deleteAnchor.remove(),delete this.deleteAnchor),this}});var C=c.Connection=function(a,b,c){this._source=a,this._target=b,this._diagram=a.diagram(),this._doc=this._diagram.doc,this._points=[],this._source.outEdges.push(this),this.initialize.apply(this,[c])};C.extend=d,_.extend(C.prototype,c.Events,{attr:{stroke:"black","stroke-width":1},end:{fill:"black",type:"basic"},start:null,labels:[],initialize:function(){},connect:function(a,b){return this._source=a,this._target=b,this._connectSource.figure=a,this._connectTarget.figure=b,a.outEdges.push(this),b.inEdges.push(this),this},render:function(){this.removeWrapper();var a,b,c,d=this.boxes(),e=E(this._doc,d,this._points);return 2===e.length&&(a=e[0],b=e[1],null!==a&&null!==b&&(c=D(a,b,this._points),this.wrapper=this._doc.path(c,!0),this.wrapper.attr(this.attr),this.wrapper.attr({cursor:"pointer",fill:"none"}),this.renderEnd(d[0],d[1],e),this.wrapper.dblclick(F.create(this)))),this},renderEnd:function(a,b,c){var d,f=this._doc,g=c[0],h=c[1],i=e.theta({x:a.cx,y:a.cy},{x:b.cx,y:b.cy}),j=360-i.degrees+180,k=360-i.degrees;return this.start&&(d=Arrows.get(this.start.type),this._startArrow=G(f,g,d(),i.radians,j).attr(this.start)),this.end&&(d=Arrows.get(this.end.type),this._endArrow=G(f,h,d(),i.radians,k).attr(this.end)),this},addPoint:function(a){return this._points.push(a),this._points=_.sortBy(this._points,function(a){return a.x}),this.render(),this},removePoint:function(a){return this._points=_.without(this._points,a),this.render(),this},removeWrapper:function(){this._startArrow&&this._startArrow.remove(),this._endArrow&&this._endArrow.remove(),_.each(this._points,function(a){a.removeWrapper()}),this.wrapper&&(this.wrapper.off(),this.wrapper.remove())},remove:function(){this.removeWrapper(),this._source.outEdges=_.without(this._source.outEdges,this._source),this._target.inEdges=_.without(this._target.inEdges,this._target),this._diagram.remove(this)},boxes:function(){return[this._source.figure.bbox(),this._target instanceof J?this._target.figure.bbox():this._target.wrapper.bbox()]}});var D=function(a,b,c){var d="M"+a.x+" "+a.y+"L",e=b.x+" "+b.y;return _.reduce(c,function(a,b){return a+b.x+" "+b.y+"L"},d)+e},E=function(a,b,c){var d,e,g,i=b[0],j=b[1],k={x:i.cx,y:i.cy},l={x:j.cx,y:j.cy};return c.length?(d=f(a,k,c[0]),e=h(a,d,i),d.path.remove(),d=f(a,c[c.length-1],l),g=h(a,d,j),d.path.remove()):(d=f(a,k,l),e=h(a,d,i),g=h(a,d,j),d.path.remove()),[e,g]},F=function(a,b){this.x=b.x,this.y=b.y,this._connection=a,this._doc=a._doc};F.create=function(a){return function(b){var c=new F(a,e.get(b));return a.addPoint(c),c.render()}},F.onstart=function(){return function(){}},F.onmove=function(a){return function(){a.x=this.cx(),a.y=this.cy(),a._connection.render()}},F.onend=function(a){return function(){a.x=this.cx(),a.y=this.cy()}},F.remove=function(a){return function(){this.remove(),this.off(),delete a.wrapper,a._connection.removePoint(a)}},F.prototype.render=function(){return this.removeWrapper(),this.wrapper=this._doc.rect(6,6).attr({fill:"black",cursor:"pointer"}).center(this.x,this.y),this.wrapper.dragstart=F.onstart(this),this.wrapper.dragend=F.onend(this),this.wrapper.dragmove=F.onmove(this),this.wrapper.draggable(),this.wrapper.dblclick(F.remove(this)),this},F.prototype.removeWrapper=function(){this.wrapper&&this.wrapper.remove()};var G=function(a,b,c,d,e){var f=b.x+-1.5*(c.dx-1)*Math.cos(d),g=b.y+1.5*(c.dy-1)*Math.sin(d);return a.path(c.path.join(" "),!0).attr(c.attr).transform({x:f,y:g,rotation:e})},H=c.Anchor=function(a,b){this._shape=a,this._figure=a.figure,this._container=a.diagram().doc,this._position=b};H.positions=["ne","se","sw","nw"],H.create=function(a){return function(b){return new H(a,b).render()}},H.figure=function(a,b,c){return a.rect(6,6).attr({x:b.x,y:b.y,fill:"blue","fill-opacity":.2,stroke:"none","stroke-width":0,type:"anchor",cursor:c+"-resize"}).draggable()},H.onstart=function(a,b,c){return function(){_.each(b.selectAnchors,function(a){a!==c&&a.remove()}),b.fixed(),b.hideConnectAnchors(),b.hideDeleteAction(),a.hideChildren()}},H.onmove=function(a,b,c){return function(d){var e,f,g,h,i=b.bbox();b.od?(e=d.x-b.od.x,f=d.y-b.od.y,b.od=d):(e=d.x,f=d.y,b.od=d),"se"===c?(g=i.width+e,h=i.height+f):"ne"===c?(g=i.width+e,h=i.height-f,b.attr({y:i.y+f})):"nw"===c?(g=i.width-e,h=i.height-f,b.attr({x:i.x+e,y:i.y+f})):(g=i.width-e,h=i.height+f,b.attr({x:i.x+e})),g=g>0?g:1,h=h>0?h:1,b.size(g,h),a.refreshEdges()}},H.onend=function(a,b){return function(){b.deselect(),b.draggable(),a.showChildren(),delete b.od}},H.prototype.render=function(){var a=this.position(),b=this._position,c=this._shape,d=this._figure,e=this._container;return this.wrapper=H.figure(e,a,b),this.wrapper.dragstart=H.onstart(c,d,this),this.wrapper.dragmove=H.onmove(c,d,b),this.wrapper.dragend=H.onend(c,d),this},H.prototype.remove=function(){this.wrapper&&(this.wrapper.remove(),delete this.wrapper)},H.prototype.position=function(){var a=this._figure.bbox(),b={};return"nw"===this._position?(b.x=a.x-3,b.y=a.y-3):"ne"===this._position?(b.x=a.x+a.width-3,b.y=a.y-3):"se"===this._position?(b.x=a.x+a.width-3,b.y=a.y+a.height-3):(b.x=a.x-3,b.y=a.y+a.height-3),b};var I=c.ConnectionAnchor=function(a,b,d){this._shape=a,this._figure=a.figure,this._container=a.diagram().doc,this._position=b,this._connectionType=d||c.Connection};I.create=function(a){return function(b){return new I(a,b.position,b.connectionType).render()}},I.figure=function(a,b){return a.circle(8).attr({cx:b.x,cy:b.y,fill:"white","fill-opacity":1,stroke:"blue","stroke-opacity":.4,type:"anchor",cursor:"pointer"}).draggable()},I.onstart=function(a,b,c){return function(){if(!a.connection){c.fixed();var d=a.clone().render();c.connectAnchors=_.without(c.connectAnchors,a),c.connectAnchors.push(d);var e=new a._connectionType(b,a);a.connection=e}}},I.onmove=function(a){return function(){a.refreshEdges()}},I.onend=function(a,b,c){return function(){var d=b.diagram().findShape(function(c){return c!==b&&a.isInside(c)});c.draggable(),d&&(a.connection._target=d,d.inEdges.push(a.connection),a.connection.render(),a.remove())}},I.prototype.isInside=function(a){var b=this.wrapper.bbox(),c=a.figure.bbox();return b.x>c.x&&b.x+b.width<c.x+c.width&&b.y>c.y&&b.y+b.height<c.x+c.height},I.prototype.bbox=function(){return this.wrapper?this.wrapper.bbox():null},I.prototype.render=function(){var a=this.position(),b=this._figure,c=this._container,d=this._shape;return this.wrapper=I.figure(c,a),this.wrapper.dragstart=I.onstart(this,d,b),this.wrapper.dragmove=I.onmove(d),this.wrapper.dragend=I.onend(this,d,b),this},I.prototype.remove=function(){this.wrapper&&(this.wrapper.remove(),delete this.wrapper)},I.prototype.position=function(){var a=this._figure.bbox(),b={};return"e"===this._position?(b.x=a.x+a.width,b.y=a.y+a.height/2):"w"===this._position?(b.x=a.x,b.y=a.y+a.height/2):"n"===this._position?(b.x=a.x+a.width/2,b.y=a.y):(b.x=a.x+a.width/2,b.y=a.y+a.height),b},I.prototype.clone=function(){return new I(this._shape,this._position,this._connectionType)};var J=c.Shape=function(a){var b=a||{};this.attributes=b,this.inEdges=[],this.outEdges=[],this.children=[],this.parent=null,this.isRoot=!1,this.isSelected=!1,this.hasConnectAnchors=!1,this.initialize.apply(this,arguments)};J.dragstart=function(a){return function(){a.hideChildren(),a.deselect()}},J.dragmove=function(a){return function(){a.refreshEdges()}},J.dragend=function(a){return function(){a.showChildren()}},_.extend(J.prototype,k,{config:{resizable:!0,selectable:!0,draggable:!0},anchors:[{position:"n"},{position:"s"},{position:"w"},{position:"e"}],render:function(){if(this.figure||(this.figure=this.createFigure())){this.renderChildren(),this.config.draggable&&(this.figure.dragstart=J.dragstart(this),this.figure.dragmove=J.dragmove(this),this.figure.dragend=J.dragend(this),this.figure.draggable());var a=this;this.config.selectable&&this.figure.on("click",function(){a.select()}),this.figure.on("click",function(b){a.trigger("click",b)})}return this},renderChildren:function(){_.each(this.children,a),this.doLayout()},showChildren:function(){_.each(this.children,function(a){a.figure.show(),a.children&&a.showChildren()}),this.isRoot&&this.layout&&this.doLayout()},hideChildren:function(){_.each(this.children,function(a){a.figure.hide(),a.children&&a.hideChildren()})},doLayout:function(){this.layout&&(this.figure.attr(this.layout.size()),this.layout.layout())},diagram:function(){for(var a=this;a.parent;)a=a.parent;return a},add:function(a){a.parent=this,this.children.push(a)},remove:function(){return this.figure&&(this.figure.off(),this.figure.remove(),_.each(this.children,function(a){a.remove()}),_.each(this.inEdges,function(a){a.remove()}),_.each(this.outEdges,function(a){a.remove()}),this.diagram().remove(this)),this},select:function(){this.isSelected=!0,this.figure.select(),this.figure.showConnectAnchors(),this.trigger("select")},deselect:function(){this.isSelected=!1,this.figure.deselect(),this.figure.hideConnectAnchors(),this.trigger("select")},move:function(a,b){return this.figure&&this.figure.move(a,b),this.doLayout(),this},refreshEdges:function(){_.each(this.inEdges,a),_.each(this.outEdges,a)},isInside:function(a){var b=this.figure.bbox();return b.x>=a.x&&b.x+b.width<=a.x+a.width&&b.y>=a.y&&b.y+b.height<=a.y+a.height},initialize:function(){},createFigure:function(){}}),J.extend=d;var K=c.Label=function(a){var b=a||{};this.attributes=b,this.initialize.apply(this,arguments)};K.extend=d,_.extend(K.prototype,k,{config:{draggable:!1,selectable:!1,resizable:!1,editable:!0},render:function(){return(this.figure||(this.figure=this.createFigure()))&&(this.config.draggable&&this.figure.draggable(),this.config.editable&&this.figure.on("dblclick",this.callEdit())),this},remove:function(){this.figure&&(this.figure.off(),this.figure.remove())},doLayout:function(){},diagram:function(){for(var a=this;a.parent;)a=a.parent;return a},callEdit:function(){var a=this;return function(){L(a.figure)}},text:function(a){return a&&(this.attributes.text=a,this.figure&&this.figure.attr("text",a),this.trigger("change:text",a)),this.attributes.text},move:function(a,b){return this.figure&&this.figure.move(a,b),this},initialize:function(){},createFigure:function(){return c.Figure.create(this,this.figure)},select:function(){},deselect:function(){},isInside:function(a){var b=this.figure.bbox();return b.x>=a.x&&b.x+b.width<=a.x+a.width&&b.y>=a.y&&b.y+b.height<=a.y+a.height}});var L=function(a){var b=a.node,c=a.bbox(),d=b.parentNode.parentNode,e=c.x,f=c.y,g=document.createElement("input");g.setAttribute("type","text"),g.setAttribute("style","position: absolute; top: "+f+"px; left: "+e+"px; width: "+c.width+"px; height: "+c.height+"px;"),g.value=a.attr("text"),d.appendChild(g);var h=function(b){b.stopImmediatePropagation(),a.attr("text",g.value),g.removeEventListener("blur",h,!0),d.removeChild(g)};g.focus(),g.addEventListener("blur",h,!0)}}();