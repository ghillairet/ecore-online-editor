jQuery(function(){function a(){var e=200,t=1200,n=250;return t>u.x+n?(u.x=u.x+n,u.y=u.y):(u.x=e,u.y=u.y+n),u}function E(e){e.stopPropagation(),e.preventDefault();var t=e.target.getAttribute("data-startbyte"),n=e.target.getAttribute("data-endbyte"),r=e.dataTransfer.files,i=r[0],s=new FileReader;s.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var t=e.target.result,n=T.create({uri:i.name});n.parse(t,Ecore.XMI),T.trigger("change")}};var o=i.slice(0,i.size);s.readAsBinaryString(o)}function S(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}window.Demo={};var e=Demo.Workbench=_.extend({},Backbone.Events),t=Ds.Label.extend({resizable:!1,draggable:!1,figure:{type:"text",text:"name: EString",height:20,stroke:"blue",position:"center-left"},initialize:function(e){e.model?this.model=e.model:this.model=Ecore.EAttribute.create({name:"name",eType:Ecore.EString});var t=this.model.get("name")+" : "+this.model.get("eType").get("name");this.setText(t)}}),n={compartment:!0,figure:{type:"rect",height:20,fill:"none",stroke:"#D8D8D1","stroke-width":2},layout:{type:"flex",columns:1,stretch:!1},accepts:[t]},r=Ds.Label.extend({resizable:!1,draggable:!1,figure:{type:"text",text:"op(): EString",height:20,stroke:"blue",position:"center-left"}}),i={compartment:!0,figure:{type:"rect",height:20,fill:"none",stroke:"none","stroke-width":2},layout:{type:"flex",columns:1,stretch:!1},accepts:[r]},s={figure:{type:"text",text:"EClass",height:30,"font-size":14}},o=Ds.Shape.extend({figure:{type:"rect",width:160,height:100,fill:"235-#F9F9D8-#FFFFFF",opacity:1,stroke:"#D8D8D1","stroke-width":2,"stroke-opacity":1},layout:{type:"flex",columns:1,stretch:!0},children:[s,n,i],initialize:function(e){e.model?(this.model=e.model,this.model.shape=this,this.createContent()):(this.model=Ecore.EClass.create({name:"MyClass"}),this.model.shape=this,this.diagram.model.get("eClassifiers").add(this.model)),this.children[0].setText(this.model.get("name"))},createContent:function(){var e=this.children[1]}}),u={x:0,y:100},f=Ds.Diagram.extend({el:"diagram",children:[o],initialize:function(e){if(e.model)this.model=e.model,this.createContent(),this.createConnections();else{this.model=Ecore.EPackage.create({name:"sample",nsURI:"http://www.example.org/sample",nsPrefix:"sample"});var t=T.create({uri:"sample.ecore"});t.get("contents").add(this.model)}},createContent:function(){this.model.get("eClassifiers").each(function(e){if(e.isTypeOf("EClass")){var t=a();this.createShape(o,{model:e,x:t.x,y:t.y})}},this)},createConnections:function(){var e;this.model.get("eClassifiers").each(function(e){e.isTypeOf("EClass")},this)}}),l=Backbone.View.extend({template:_.template('<div class="nav-box"></div>'),templateHeader:_.template('<div class="nav-box-header"><%= title %><i class="icon-large"></i></div>'),_icon_up:"icon-double-angle-up",_icon_down:"icon-double-angle-down",events:{"click .icon-double-angle-up":"hide","click .icon-double-angle-down":"show"},initialize:function(e){this.navigator=e.navigator,this.views=[]},render:function(){var e=this.template(),t=this.templateHeader({title:this.title});return this.setElement(e),this.$el.append(t),$('i[class~="icon-large"]',this.$el).addClass(this._icon_up),this},show:function(){_.each(this.views,function(e){this.$el.append(e.render().$el)},this),$('i[class~="'+this._icon_down+'"]',this.$el).removeClass(this._icon_down).addClass(this._icon_up)},hide:function(){_.each(this.views,function(e){e.remove()}),$('i[class~="'+this._icon_up+'"]',this.$el).removeClass(this._icon_up).addClass(this._icon_down)},remove:function(){return _.each(this.views,function(e){e.remove()}),this.views.length=0,Backbone.View.prototype.remove.apply(this)}}),c=Backbone.View.extend({template:_.template('<div class="nav-header"><div class="nav-header-content"></div></div>'),templateTitle:_.template("<h3>Ecore Editor</h3>"),templateHide:_.template('<i class="icon-double-angle-left icon-large"></i>'),templateShow:_.template('<i class="icon-double-angle-right icon-large"></i>'),events:{"click .icon-double-angle-left":"hide","click .icon-double-angle-right":"show"},initialize:function(e){_.bindAll(this)},render:function(e){this.$el&&this.remove();var t=this.template();this.setElement(t);var n=$(".nav-header-content",this.$el),r,i;return e?(r=this.templateShow(),n.append(r)):(i=this.templateTitle(),r=this.templateHide(),n.append(i).append(r)),this},hide:function(){this.trigger("hide")},show:function(){this.trigger("show")}}),h=l.extend({title:"Palette",items:["EPackage","EClass","EEnum","EEnumLiteral","EDataType","EAttribute","EReference","EOperation"],initialize:function(e){_.bindAll(this),l.prototype.initialize.apply(this,[e])},render:function(){return l.prototype.render.apply(this),_.each(this.items,function(e){var t=new p({shape:e});this.views.push(t),this.$el.append(t.render().$el)},this),this}}),p=Backbone.View.extend({template:_.template('<div class="nav-row"><i class="icon-edit-<%= shape %>"></i><span><%= shape %></span></div>'),initialize:function(e){this.shape=e.shape},render:function(){var e=this.template({shape:this.shape});return this.setElement(e),this}}),d=l.extend({title:"Resources",initialize:function(e){_.bindAll(this,"show","hide"),l.prototype.initialize.apply(this,[e]),this.modal=new y({model:this.model}),this.model.on("change",this.render)},render:function(){l.prototype.render.apply(this),this.model.get("resources").each(this.addResource,this);var e=(new v).render();return this.views.push(e),this.$el.append(e.$el),_.each(this.views,function(e){e.on("create",this.createResource,this),e.on("open:editor",function(){this.navigator.trigger("open:editor",e.model)},this),e.on("open:diagram",function(){this.navigator.trigger("open:diagram",e.model)},this),e.on("remove",this.deleteResource,this)},this),this},addResource:function(e){var t=new v({model:e});return t.render(),this.views.push(t),this.$el.append(t.$el),this},deleteResource:function(e){},createResource:function(e){this.modal.render().show()}}),v=Backbone.View.extend({template:_.template('<div class="nav-row"></div>'),templateIcon:_.template('<i class="icon-folder-close icon-large"></i>'),templateLabel:_.template("<span> <%= uri %></span>"),templateRemove:_.template('<i class="icon-remove icon-large"></i>'),templateDiagram:_.template('<i class="icon-sitemap icon-large"</i>'),templateAdd:_.template('<i class="icon-plus icon-large"></i>'),events:{click:"openEditor","click .icon-remove":"remove","click .icon-plus":"createResource","click .icon-sitemap":"openDiagram"},initialize:function(e){_.bindAll(this)},render:function(){var e=this.template();this.setElement(e);if(this.model){var t=this.templateIcon(),n=this.templateLabel({uri:this.model.get("uri")}),r=this.templateRemove(),i=this.templateDiagram();this.$el.children().remove(),this.$el.append(t).append(n).append(r).append(i)}else{var s=this.templateAdd();this.$el.children().remove(),this.$el.append(s)}return this},openEditor:function(){this.model&&this.trigger("open:editor",this.model)},createResource:function(){this.trigger("create",this)},openDiagram:function(){this.model&&this.trigger("open:diagram",this.model)},remove:function(){return this.trigger("remove",this.model),Backbone.View.prototype.remove.apply(this)}}),m=Backbone.View.extend({el:"#navigator",initialize:function(){_.bindAll(this),this.resourceSetView=new d({model:this.model,navigator:this}),this.paletteView=new h({navigator:this}),this.header=new c,this.header.on("hide",this.hide),this.header.on("show",this.show)},render:function(){return this.$header=this.header.render().$el,this.$el.append(this.$header),this.$el.append(this.resourceSetView.render().$el),this.$el.append(this.paletteView.render().$el),this},hide:function(){this.trigger("hide"),this.resourceSetView.remove(),this.paletteView.remove(),this.$header=this.header.render(!0).$el,this.$el.append(this.$header),this.$el.animate({width:"30px"},100)},show:function(){this.trigger("show"),this.$el.animate({width:"280px"},100),this.render()}}),g=Backbone.View.extend({template:_.template('<div id="<%= id =>" class="modal hide fade"></div>'),templateHeader:_.template('<div class="modal-header"></div>'),templateBody:_.template('<div class="modal-body"></div>'),templateFooter:_.template('<div class="modal-footer"><a href="#" class="btn mclose">Close</a><a href="#" class="btn confirm">Confirm</a></div>'),render:function(){var e=this.template({id:this.cid}),t=this.templateHeader(),n=this.templateBody(),r=this.templateFooter();return this.setElement(e),this.$el.append(t),this.$el.append(n),this.$el.append(r),this.$header=$('div[class="modal-header"]',this.$el),this.$body=$('div[class="modal-body"]',this.$el),this.$footer=$('div[class="modal-footer"]',this.$el),this},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")}}),y=g.extend({templateForm:_.template('<form class="form-horizontal"></form>'),templateControlURI:_.template('<div class="control-group"><label class="control-label" for="inputURI">URI</label><div class="controls"><input type="text" id="inputURI" placeholder="URI"></div></div>'),templateControlElement:_.template('<div class="control-group"><label class="control-label" for="inputElement">Element</label><div class="controls"><select type="text" id="selectElement"></select></div>'),templateHeaderContent:_.template('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3>Create Resource</h3></div>'),templateOptions:_.template('<% _.each(options, function(option) { %> <option><%= option.get("name") %></option> <% }); %>'),events:{'click .modal-footer a[class~="confirm"]':"onConfirm",'click .modal-footer a[class~="mclose"]':"onClose"},initialize:function(){_.bindAll(this,"onConfirm")},render:function(){g.prototype.render.apply(this);var e=this.templateForm(),t=this.templateHeaderContent(),n=this.templateControlURI(),r=this.templateControlElement();this.$header.append(t),this.$body.append(e),this.$form=$("form",this.$body),this.$form.append(n).append(r),this.$select=$("#selectElement",this.$form),console.log(this.model),this.classes=this.model.elements("EClass"),this.classes=_.filter(this.classes,function(e){return!e.get("abstract")});var i=this.templateOptions({options:this.classes});return this.$select.append(i),this},createResource:function(e,t){var n=this.model.create({uri:e});n.get("contents").add(t.create()),this.model.trigger("change add",n)},onClose:function(){this.hide()},onConfirm:function(){var e=$("#inputURI",this.$form).val(),t=$("option:selected",this.$select).val();if(e&&e.length&&t){var n=_.find(this.classes,function(e){return e.get("name")===t});n&&this.createResource(e,n)}this.$el.modal("hide")}}),b=Ecore.Edit.Window.extend({el:"#property-window",title:"Property",draggable:!0,content:new Ecore.Edit.PropertySheet}),w=Ecore.Edit.TabPanel.extend({el:"#main",open:function(e,t){var n=this.getByModel(e);n||(n=new Ecore.Edit.TreeTabEdior({model:e}),this.add(n),n.render()),n.show()},expand:function(){this.$el[0].style.left="20px"}}),x=$("#navigator")[0];x&&(x.addEventListener("dragover",S,!1),x.addEventListener("drop",E,!1));var T=Ecore.ResourceSet.create(),N=T.create({uri:Ecore.EcorePackage.get("nsURI")}),C=T.create({uri:"http://www.eclipselabs.org/ecore/2012/resources"}),k=T.create({uri:"sample.ecore"}),L=Ecore.EPackage.create({name:"sample",nsPrefix:"sample",nsURI:"http://example.org/sample",eClassifiers:[{eClass:Ecore.EClass,name:"Foo",eStructuralFeatures:[{eClass:Ecore.EAttribute,name:"bar",eType:Ecore.EString}]}]});k.get("contents").add(L),e.properties=new b,e.editorTab=new w,e.navigator=new m({model:T}),e.navigator.render(),e.navigator.on("open:editor",function(e){this.editorTab.render().open(e)},e),e.navigator.on("open:diagram",function(e){this.editorTab.render().open(e,!0)},e),e.navigator.on("hide",function(){$(".part").animate({left:"30px"},100)},e),e.navigator.on("show",function(){$(".part").animate({left:"280px"},100)},e),e.editorTab.on("select",function(e){this.properties.content.model=e},e),T.on("add",function(e){this.editorTab.render().open(e),this.properties.content.model=e,this.properties.render()},e)});