function layout(){var e=10,t=800,n=150;return t>current.x+n?(current.x=current.x+n,current.y=current.y):(current.x=e,current.y=current.y+n),current}function handleFileSelect(e){e.stopPropagation(),e.preventDefault();var t=e.target.getAttribute("data-startbyte"),n=e.target.getAttribute("data-endbyte"),r=e.dataTransfer.files,i=r[0],s=new FileReader;s.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var t=e.target.result,n=resourceSet.create({uri:i.name});n.parse(t,Ecore.XMI),resourceSet.trigger("change")}};var o=i.slice(0,i.size);s.readAsBinaryString(o)}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}var EReferenceConnection=Ds.Connection.extend({figure:{stroke:"black","stroke-width":2},end:{type:"basic"},labels:[{text:"property",position:"end"}],initialize:function(e){e.model&&(this.model=e.model,this.labels[0].set("text",this.model.get("name")))}}),ESuperTypesConnection=Ds.Connection.extend({figure:{stroke:"black","stroke-width":2},end:{fill:"white",type:"basic"}}),FeatureShape=Ds.Label.extend({resizable:!1,draggable:!1,selectable:!1,figure:{type:"text",position:"left"},gridData:{horizontalAlignment:"beginning",verticalAlignment:"center",grabExcessHorizontalSpace:!0}}),FeatureCompartment=Ds.Shape.extend({draggable:!1,selectable:!1,resizable:!1,figure:{type:"rect",height:20,width:100,fill:"235-#F9F9D8-#FFFFFF","fill-opacity":0,stroke:"#D8D8D1","stroke-width":2},layout:{type:"grid",marginHeight:8,marginWidth:8,vgap:8,columns:1},gridData:{horizontalAlignment:"fill",verticalAlignment:"fill",grabExcessHorizontalSpace:!0}}),EAttributeShape=FeatureShape.extend({initialize:function(e){e.model?this.model=e.model:this.model=Ecore.EAttribute.create({name:"name",eType:Ecore.EString});var t=this.model.get("name");this.model.has("eType")&&(t+=" : "+this.model.get("eType").get("name")),this.setText(t),this.on("change:text",function(e){var t=e.getText(),n=t.split(":"),r=n[0].trim(),i;n.length>1&&(i=n[1].trim()),this.model.set("name",r)},this)}}),EAttributeCompartment=FeatureCompartment.extend({accepts:[EAttributeShape],initialize:function(){this.on("click",this.addElement),this.on("mouseover",this.handleMouseOver),this.on("mouseout",this.handleMouseOut)},handleMouseOut:function(){this.set("cursor","default")},handleMouseOver:function(e){var t=Workbench.palette,n=t.selected,r;n&&(r=n.shape,this.canAdd(r)?this.set("cursor","copy"):this.set("cursor","no-drop"))},addElement:function(e){var t=Workbench.palette,n=t.selected;if(n&&this.canAdd(n.shape)){var r=new n.shape({});this.add(r),this.parent.render(),t.selected=null;var i=this.parent.model;r instanceof EAttributeShape?i.get("eStructuralFeatures").add(r.model):r instanceof EOperationShape&&i.get("eOperations").add(r.model)}}}),EOperationShape=FeatureShape.extend({initialize:function(e){e.model?this.model=e.model:this.model=Ecore.EOperation.create({name:"name",eType:Ecore.EString});var t=this.model.get("eType");t=t?t.get("name"):"";var n=this.model.get("name")+"(): "+t;this.setText(n)}}),EOperationCompartment=FeatureCompartment.extend({accepts:[EOperationShape],initialize:function(){this.on("click",this.addElement),this.on("mouseover",this.handleMouseOver),this.on("mouseout",this.handleMouseOut)},handleMouseOut:function(){this.set("cursor","default")},handleMouseOver:function(e){var t=Workbench.palette,n=t.selected,r;n&&(r=n.shape,this.canAdd(r)?this.set("cursor","copy"):this.set("cursor","no-drop"))},addElement:function(e){var t=Workbench.palette,n=t.selected;if(n&&this.canAdd(n.shape)){var r=new n.shape({});this.add(r),this.parent.render(),t.selected=null}}}),ClassifierLabel={figure:{type:"text","font-size":14,"font-weight":"bold",height:30},gridData:{horizontalAlignment:"center",grabExcessHorizontalSpace:!0}},ClassifierShape=Ds.Shape.extend({figure:{type:"rect",width:160,height:100,fill:"235-#F9F9D8-#FFFFFF",opacity:1,stroke:"#D8D8D1","stroke-width":2,"stroke-opacity":1},layout:{type:"grid",columns:1,hgap:0,vgap:0,marginHeight:0,marginWidth:0}}),EEnumLiteralShape=FeatureShape.extend({}),EEnumCompartment=FeatureCompartment.extend({accepts:[EEnumLiteralShape]}),EEnumShape=ClassifierShape.extend({children:[ClassifierLabel,EEnumCompartment],initialize:function(e){if(!this.diagram)return;e.model?this.model=e.model:(this.model=Ecore.EEnum.create({name:"EEnum"}),this.diagram.model.get("eClassifiers").add(this.model)),this.children[0].setText(this.model.get("name"))}}),EDataTypeCompartment=Ds.Shape.extend({draggable:!1,selectable:!1,resizable:!1,figure:{type:"rect",height:20,fill:"white","fill-opacity":0,stroke:"#D8D8D1","stroke-width":2},gridData:{horizontalAlignment:"fill",verticalAlignment:"fill",grabExcessHorizontalSpace:!0}}),EDataTypeShape=ClassifierShape.extend({children:[ClassifierLabel,EDataTypeCompartment],initialize:function(e){if(!this.diagram)return;e.model?this.model=e.model:(this.model=Ecore.EDataType.create({name:"EDataType"}),this.diagram.model.get("eClassifiers").add(this.model)),this.children[0].setText(this.model.get("name"))}}),EClassShape=ClassifierShape.extend({children:[ClassifierLabel,EAttributeCompartment,EOperationCompartment],initialize:function(e){if(!this.diagram)return;e.model?(this.model=e.model,this.model.shape=this,this.createContent()):(this.model=Ecore.EClass.create({name:"MyClass"}),this.model.shape=this,this.diagram.model.get("eClassifiers").add(this.model)),this.children[0].setText(this.model.get("name")),this.on("click",this.toFront),this.on("mousedown",this.doConnect)},doConnect:function(e){var t=Workbench.palette,n=t.selected;n&&n.connection&&(this.dragConnection(e,n.connection),this.on("connect:source",function(){t.selected=null}))},createContent:function(){_.each(this.model.get("eAttributes"),function(e){var t=this.diagram.createShape(EAttributeShape,{model:e});this.children[1].add(t)},this),this.model.get("eOperations").each(function(e){var t=this.diagram.createShape(EOperationShape,{model:e});this.children[2].add(t)},this)}}),EPackageCompartment=Ds.Shape.extend({draggable:!1,selectable:!1,resizable:!1,figure:{type:"rect",fill:"270-#B8A8C8-#FFF",height:100,stroke:"grey"},initialize:function(){this.on("click",function(){this.parent.select()},this)}}),EPackageHeadShape=Ds.Shape.extend({draggable:!1,selectable:!1,resizable:!1,figure:{type:"rect",height:30,fill:"none",stroke:"none"},layout:{type:"xy"},children:[{draggable:!1,selectable:!1,resizable:!1,figure:{type:"rect",height:30,width:80,x:0,y:0,stroke:"grey",fill:"#B8A8C8"},layout:{type:"grid",columns:1,marginHeight:5,marginWidth:5},children:[{figure:{type:"text","font-size":11,text:"EPackage"},gridData:{horizontalAlignment:"center",grabExcessHorizontalSpace:!0,grabExcessVerticalSpace:!0}}]}]}),EPackageShape=Ds.Shape.extend({figure:{type:"rect",fill:"yellow","fill-opacity":0,stroke:"none",height:120,width:160},initialize:function(e){if(!this.diagram)return;var t=new EPackageHeadShape({diagram:this.diagram}),n=new EPackageCompartment({diagram:this.diagram});this.add(t),this.add(n),this.layout.north=t,this.layout.center=n,this.on("click",this.select)},layout:{type:"border",vgap:0,hgap:0}}),current={x:0,y:100},EcoreDiagram=Ds.Diagram.extend({width:2e3,height:2e3,children:[EPackageShape,EClassShape,EDataTypeShape,EEnumShape],initialize:function(e){_.bindAll(this);if(e.model)this.model=e.model,this.createContent(),this.createConnections();else{this.model=Ecore.EPackage.create({name:"sample",nsURI:"http://www.example.org/sample",nsPrefix:"sample"});var t=resourceSet.create({uri:"sample.ecore"});t.get("contents").add(this.model)}this.on("click",this.addFromPalette),this.on("click",function(){Workbench.palette.selected=null}),this.on("mouseover",this.handleMouseOver)},handleMouseOver:function(e){var t=Workbench.palette,n=t.selected;n?_.contains(["EClass","EDataType","EEnum","EPackage"],n.title)?this.wrapper.attr("cursor","copy"):this.wrapper.attr("cursor","no-drop"):this.wrapper.attr("cursor","default")},addFromPalette:function(e){var t=Workbench.palette,n=t.selected;n&&typeof n.shape=="function"&&(this.createShape(n.shape,Ds.Point.get(this,e)).render(),t.selected=null)},createContent:function(){this.model.get("eClassifiers").each(function(e){if(e.isTypeOf("EClass")){var t=layout(),n=100,r=100;this.createShape(EClassShape,{model:e,x:n,y:n})}},this)},createConnections:function(){var e;this.model.get("eClassifiers").each(function(e){e.isTypeOf("EClass")},this)}}),NavBox=Backbone.View.extend({template:_.template('<div class="nav-box"></div>'),templateHeader:_.template('<div class="nav-box-header"><%= title %><i class="icon-large"></i></div>'),_icon_up:"icon-double-angle-up",_icon_down:"icon-double-angle-down",events:{"click .icon-double-angle-up":"hide","click .icon-double-angle-down":"show"},initialize:function(e){this.navigator=e.navigator,this.views=[]},render:function(){var e=this.template(),t=this.templateHeader({title:this.title});return this.setElement(e),this.$el.append(t),$('i[class~="icon-large"]',this.$el).addClass(this._icon_up),this},show:function(){_.each(this.views,function(e){this.$el.append(e.render().$el)},this),$('i[class~="'+this._icon_down+'"]',this.$el).removeClass(this._icon_down).addClass(this._icon_up)},hide:function(){_.each(this.views,function(e){e.remove()}),$('i[class~="'+this._icon_up+'"]',this.$el).removeClass(this._icon_up).addClass(this._icon_down)},remove:function(){return _.each(this.views,function(e){e.remove()}),this.views.length=0,Backbone.View.prototype.remove.apply(this)}}),NavigatorHeaderView=Backbone.View.extend({template:_.template('<div class="nav-header"><div class="nav-header-content"></div></div>'),templateTitle:_.template("<h3>Ecore Editor</h3>"),templateHide:_.template('<i class="icon-double-angle-left icon-large"></i>'),templateShow:_.template('<i class="icon-double-angle-right icon-large"></i>'),events:{"click .icon-double-angle-left":"hide","click .icon-double-angle-right":"show"},initialize:function(e){_.bindAll(this)},render:function(e){this.$el&&this.remove();var t=this.template();this.setElement(t);var n=$(".nav-header-content",this.$el),r,i;return e?(r=this.templateShow(),n.append(r)):(i=this.templateTitle(),r=this.templateHide(),n.append(i).append(r)),this},hide:function(){this.trigger("hide")},show:function(){this.trigger("show")}}),PaletteView=NavBox.extend({title:"Palette",tools:{},shapes:{EPackage:EPackageShape,EClass:EClassShape,EEnum:EEnumShape,EEnumLiteral:EEnumLiteralShape,EDataType:EDataTypeShape,EAttribute:EAttributeShape,EOperation:EOperationShape},connections:{EReference:EReferenceConnection,ESuperTypes:ESuperTypesConnection},initialize:function(e){_.bindAll(this),NavBox.prototype.initialize.apply(this,[e])},render:function(){return NavBox.prototype.render.apply(this),_.each(this.shapes,function(e,t){var n=new PaletteItemView({palette:this,shape:e,title:t});this.views.push(n),this.$el.append(n.render().$el)},this),_.each(this.connections,function(e,t){var n=new PaletteItemView({palette:this,connection:e,title:t});this.views.push(n),this.$el.append(n.render().$el)},this),this}}),PaletteItemView=Backbone.View.extend({template:_.template('<div class="nav-row"><i class="icon-edit-<%= title %>"></i><span><%= title %></span></div>'),events:{click:"select"},initialize:function(e){_.bindAll(this),this.palette=e.palette,this.shape=e.shape,this.connection=e.connection,this.title=e.title},render:function(){var e=this.template({title:this.title});return this.setElement(e),this},select:function(){this.palette.selected=this}}),ToolItemView=PaletteItemView.extend({template:_.template('<i class="<%= icon %>"></i><span><%= title %></span>'),initialize:function(e){PaletteItemView.prototype.initialize.apply(this,[e]),this.icon=e.icon}}),ResourceSetView=NavBox.extend({title:"Resources",initialize:function(e){_.bindAll(this,"show","hide"),NavBox.prototype.initialize.apply(this,[e]),this.modal=new CreateResourceModal({model:this.model}),this.model.on("change add remove",this.render)},render:function(){NavBox.prototype.render.apply(this),this.model.get("resources").each(this.addResource,this);var e=(new ResourceView).render();return this.views.push(e),this.$el.append(e.$el),_.each(this.views,function(e){e.on("create",this.createResource,this),e.on("open:editor",function(){this.navigator.trigger("open:editor",e.model)},this),e.on("open:diagram",function(){this.navigator.trigger("open:diagram",e.model)},this),e.on("remove",this.deleteResource,this)},this),this},addResource:function(e){var t=new ResourceView({model:e});return t.render(),this.views.push(t),this.$el.append(t.$el),this},deleteResource:function(e){},createResource:function(e){this.modal.render().show()}}),ResourceView=Backbone.View.extend({template:'<div class="nav-row"></div>',templateResource:_.template('<i class="<%= icon1 %>"></i><span> <%= uri %></span><i class="<%= icon2 %>""></i><i class="<%= icon3 %>""</i>'),templateAdd:_.template('<i class="<%= icon4 %>"></i>'),events:{click:"openEditor","click .icon-remove":"remove","click .icon-plus":"createResource","click .icon-sitemap":"openDiagram"},icons:[{klass:"icon-folder-close icon-large"},{klass:"icon-remove icon-large",tooltip:"Delete this resource"},{klass:"icon-sitemap icon-large",tooltip:"Open this resoure in a diagram"},{klass:"icon-plus icon-large",tooltip:"Create a new resource"}],initialize:function(e){_.bindAll(this)},render:function(){return this.setElement(this.template),this.model?(this.$el.children().remove(),this.$el.append(this.templateResource({icon1:this.icons[0].klass,icon2:this.icons[1].klass,icon3:this.icons[2].klass,uri:this.model.get("uri")}))):(this.$el.children().remove(),this.$el.append(this.templateAdd({icon4:this.icons[3].klass}))),this.addTooltip(),this},addTooltip:function(){_.each(this.icons,function(e){var t=$('i[class="'+e.klass+'"]',this.$el);t.length&&e.tooltip&&t.tooltip({placement:"right",title:e.tooltip,trigger:"hover"})},this)},openEditor:function(e){e&&e.stopPropagation(),this.model&&this.trigger("open:editor",this.model)},createResource:function(){this.trigger("create",this)},openDiagram:function(e){e&&e.stopPropagation(),this.model&&this.trigger("open:diagram",this.model)},remove:function(){return this.trigger("remove",this.model),Backbone.View.prototype.remove.apply(this)}}),NavigatorView=Backbone.View.extend({el:"#navigator",initialize:function(){_.bindAll(this),this.resourceSetView=new ResourceSetView({model:this.model,navigator:this}),this.paletteView=new PaletteView({navigator:this}),this.header=new NavigatorHeaderView,this.header.on("hide",this.hide),this.header.on("show",this.show)},render:function(){return this.$header=this.header.render().$el,this.$el.append(this.$header),this.$el.append(this.resourceSetView.render().$el),this.$el.append(this.paletteView.render().$el),this},hide:function(){this.trigger("hide"),this.resourceSetView.remove(),this.paletteView.remove(),this.$header=this.header.render(!0).$el,this.$el.append(this.$header),this.$el.animate({width:"30px"},100)},show:function(){this.trigger("show"),this.$el.animate({width:"280px"},100),this.render()}}),ModalView=Backbone.View.extend({template:_.template('<div id="<%= id =>" class="modal hide fade"></div>'),templateHeader:_.template('<div class="modal-header"></div>'),templateBody:_.template('<div class="modal-body"></div>'),templateFooter:_.template('<div class="modal-footer"><a href="#" class="btn mclose">Close</a><a href="#" class="btn confirm">Confirm</a></div>'),render:function(){var e=this.template({id:this.cid}),t=this.templateHeader(),n=this.templateBody(),r=this.templateFooter();return this.setElement(e),this.$el.append(t),this.$el.append(n),this.$el.append(r),this.$header=$('div[class="modal-header"]',this.$el),this.$body=$('div[class="modal-body"]',this.$el),this.$footer=$('div[class="modal-footer"]',this.$el),this},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")}}),CreateResourceModal=ModalView.extend({templateForm:_.template('<form class="form-horizontal"></form>'),templateControlURI:_.template('<div class="control-group"><label class="control-label" for="inputURI">URI</label><div class="controls"><input type="text" id="inputURI" placeholder="URI"></div></div>'),templateControlElement:_.template('<div class="control-group"><label class="control-label" for="inputElement">Element</label><div class="controls"><select type="text" id="selectElement"></select></div>'),templateHeaderContent:_.template('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3>Create Resource</h3></div>'),templateOptions:_.template('<% _.each(options, function(option) { %> <option><%= option.get("name") %></option> <% }); %>'),events:{'click .modal-footer a[class~="confirm"]':"onConfirm",'click .modal-footer a[class~="mclose"]':"onClose"},initialize:function(){_.bindAll(this,"onConfirm")},render:function(){ModalView.prototype.render.apply(this);var e=this.templateForm(),t=this.templateHeaderContent(),n=this.templateControlURI(),r=this.templateControlElement();this.$header.append(t),this.$body.append(e),this.$form=$("form",this.$body),this.$form.append(n).append(r),this.$select=$("#selectElement",this.$form),this.classes=this.model.elements("EClass"),this.classes=_.filter(this.classes,function(e){return!e.get("abstract")});var i=this.templateOptions({options:this.classes});return this.$select.append(i),this},createResource:function(e,t){var n=this.model.create({uri:e});n.get("contents").add(t.create()),this.model.trigger("change add",n)},onClose:function(){this.hide()},onConfirm:function(){var e=$("#inputURI",this.$form).val(),t=$("option:selected",this.$select).val();if(e&&e.length&&t){var n=_.find(this.classes,function(e){return e.get("name")===t});n&&this.createResource(e,n)}this.$el.modal("hide")}}),PropertyWindow=Ecore.Edit.Window.extend({el:"#property-window",title:"Property",draggable:!0,content:new Ecore.Edit.PropertySheet,render:function(){return this.content.model=this.model,Ecore.Edit.Window.prototype.render.apply(this)}}),EcoreDiagramEditor=Ecore.Edit.TabEditor.extend({tmpl:_.template('<div id="diagram-<%= id %>" style="width: 100%; height: 100%;"></div>'),initialize:function(e){_.bindAll(this),this.title=this.getTitle()+".diagram",Ecore.Edit.TabEditor.prototype.initialize.apply(this,[e]),this.diagram=new EcoreDiagram({model:this.model.get("contents").first()})},renderContent:function(){this.$diagram||(this.$diagram=$(this.tmpl({id:this.cid})),this.$content.append(this.$diagram),this.diagram.setElement(this.$diagram[0]))},show:function(){return Ecore.Edit.TabEditor.prototype.show.apply(this)}}),EcoreTreeEditor=Ecore.Edit.TreeTabEditor.extend({editElement:function(){Workbench.properties.model=this.tree.selected.model,Workbench.properties.render()}}),EcoreTabPanel=Ecore.Edit.TabPanel.extend({el:"#main",open:function(e,t){var n=this.find(e,t);n||(t?n=new EcoreDiagramEditor({model:e}):n=new EcoreTreeEditor({model:e}),this.add(n),n.render()),n.show(),t&&n.diagram.render()},find:function(e,t){return _.find(this.editors,function(n){return n.model===e?t?typeof n.diagram=="object":typeof n.diagram!="object":!1})},expand:function(){this.$el[0].style.left="20px"}}),dropzone=$("#navigator")[0];dropzone&&(dropzone.addEventListener("dragover",handleDragOver,!1),dropzone.addEventListener("drop",handleFileSelect,!1)),window.onload=function(){window.Workbench=_.extend({},Backbone.Events);var e=Ecore.ResourceSet.create(),t=e.create({uri:Ecore.EcorePackage.get("nsURI")}),n=e.create({uri:"http://www.eclipselabs.org/ecore/2012/resources"}),r=e.create({uri:"sample.ecore"}),i=Ecore.EPackage.create({name:"sample",nsPrefix:"sample",nsURI:"http://example.org/sample",eClassifiers:[{eClass:Ecore.EClass,name:"Foo",eStructuralFeatures:[{eClass:Ecore.EAttribute,name:"bar",eType:Ecore.EString}]}]});r.get("contents").add(i),Workbench.properties=new PropertyWindow,Workbench.editorTab=new EcoreTabPanel,Workbench.navigator=new NavigatorView({model:e}),Workbench.palette=Workbench.navigator.paletteView,Workbench.navigator.render(),Workbench.navigator.on("open:editor",function(e){this.editorTab.render().open(e)},Workbench),Workbench.navigator.on("open:diagram",function(e){this.editorTab.render().open(e,!0)},Workbench),Workbench.navigator.on("hide",function(){$("#main").animate({left:"50px"},100)},Workbench),Workbench.navigator.on("show",function(){$("#main").animate({left:"300px"},100)},Workbench),Workbench.editorTab.on("select",function(e){this.properties.content.model=e},Workbench),Workbench.properties.content.on("change",function(){console.log(Workbench.editorTab)},Workbench),e.on("add",function(e){this.editorTab.render().open(e),this.properties.content.model=e,this.properties.render()},Workbench)};