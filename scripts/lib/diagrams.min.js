(function(e){"use strict";function g(e){var t=e.paper(),n=e.get("type"),r=0,i=0,s;switch(n){case"rect":case"circle":case"ellipse":s=t[n](r,i);break;case"path":s=t.path(e.get("path"));break;default:s=null}return s&&(s.controller=e),s}function y(e){return e.figure&&e.figure.type==="image"}function b(e){return e.figure&&e.figure.type==="text"}function w(e){return e.compartment===!0}function S(e){var t=e.layout,n=t?t.type:null;return function(){switch(n){case"xy":return new M(e,t);case"flow":return new O(e,t);case"grid":return new k(e,t);case"flex":return new L(e,t);case"border":return new D(e,t);default:return null}}()}function X(e,t){var n=e.figure?e.figure.position||"center":"center";if(t&&t.position){n=t.position;if(n.x&&n.y)return n;if(_.include(W,n))return n}return n}function Z(e,t){this.connection=e,this.paper=e.paper(),this.x=t.x,this.y=t.y}function et(e,t,n,r){var i=["M",e.x,e.y],s=0,o=n.length;for(;s<o;s++)i.push("L",n[s].x,n[s].y);return i.push("L",t.x,t.y),i}function tt(e,t){var n=-(t.y-e.y),r=t.x-e.x,i=Math.atan2(n,r);return i<0&&(i=2*Math.PI+i),{degrees:180*i/Math.PI,radians:i}}var t={version:"0.1.0"};e.Ds=t,e.Diagrams=t;var n=function(e){return _.isNumber(e)&&_.isFinite(e)?e>0:!1};Raphael.el.is=function(e){return this.type===e},Raphael.el.x=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cx");default:return this.attr("x")}},Raphael.el.y=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cy");default:return this.attr("y")}};var r=function(e,t,r,i,s){_.include(["ne","nw","n"],r)&&(t=-t),_.include(["nw","sw","n"],r)&&(e=-e);var o=this.orx+e,u=this.orx+t;return{rx:n(o)?o:this.orx,ry:n(u)?u:this.ory}},i=function(e,t,r,i,s){_.include(["ne","nw","n"],r)&&(t=-t);var o=this.or+(t<0?-1:1)*Math.sqrt(2*t*t);return{r:n(o)?o:this.or}},s=function(e,t,n,r,i){var s=this.ox,o=this.oy,u=this.ow,a=this.oh;return n!=="n"&&n!=="s"&&(u=this.ow+e),n!=="w"&&n!=="e"&&(a=this.oh+t),_.include(["sw","nw","w"],n)&&(u=this.ow-e,u<r.width&&(e-=r.width-u),s=this.ox+e),_.include(["ne","nw","n"],n)&&(a=this.oh-t,a<r.height&&(t-=r.height-a),o=this.oy+t),a<r.height&&(a=r.height),u<r.width&&(u=r.width),u>i.width&&(u=i.width),a>i.height&&(a=i.height),s<i.x&&(s=i.x),o<i.y&&(o=i.y),{width:u,height:a,y:o,x:s}};Raphael.el.rdxy=function(e,t,n,o,u){switch(this.type){case"ellipse":return r.apply(this,[e,t,direciton,o,u]);case"circle":return i.apply(this,[e,t,n,o,u]);case"rect":return s.apply(this,[e,t,n,o,u]);default:return{}}},Raphael.el.o=function(){var e=this.attr();return this.oa=_.clone(e),this.oa.fill=this.attr("fill"),this.oa["fill-opacity"]===undefined&&(this.oa["fill-opacity"]=1),this.ox=this.x(),this.oy=this.y(),this.ow=e.width,this.oh=e.height,this.or=e.r,this.orx=e.rx,this.ory=e.ry,this},Raphael.el.reset=function(){var e=this.oa;return e?(e.width=this.attrs.width,e.height=this.attrs.height,e.r=this.attrs.r,e.cx=this.attrs.cx,e.cy=this.attrs.cy,e.x=this.attrs.x,e.y=this.attrs.y,this.attr(e),delete this.oa,this):this},Raphael.el.getABox=function(){var e=this.getBBox(),t={x:e.x,y:e.y,width:e.width,height:e.height,xLeft:e.x,xCenter:e.x+e.width/2,xRight:e.x+e.width,yTop:e.y,yMiddle:e.y+e.height/2,yBottom:e.y+e.height};return t.center={x:t.xCenter,y:t.yMiddle},t.topLeft={x:t.xLeft,y:t.yTop},t.topRight={x:t.xRight,y:t.yTop},t.bottomLeft={x:t.xLeft,y:t.yBottom},t.bottomRight={x:t.xRight,y:t.yBottom},t.top={x:t.xCenter,y:t.yTop},t.bottom={x:t.xCenter,y:t.yBottom},t.left={x:t.xLeft,y:t.yMiddle},t.right={x:t.xRight,y:t.yMiddle},t},Raphael.fn.polyline=function(e,t){var n=["M",e,t,"L"];for(var r=2;r<arguments.length;r++)n.push(arguments[r]);return this.path(n.join(" "))},Raphael.fn.triangle=function(e,t,n){var r=["M",e,t];return r=r.concat(["L",e+n/2,t+n]),r=r.concat(["L",e-n/2,t+n]),this.path(r.concat(["z"]).join(" "))};var o=function(t,n){var r;n===undefined?(r=t.split(t.indexOf("@")===-1?" ":"@"),this.x=parseInt(r[0],10),this.y=parseInt(r[1],10)):(this.x=t,this.y=n)};o.get=function(e,t){if(window.event&&window.event.contentOverflow!==undefined)return new o(window.event.x,window.event.y);if(t.offsetX!==undefined&&t.offsetY!==undefined)return new o(t.offsetX,t.offsetY);var n=t.pageX,r=t.pageY,i=e.canvas.parentNode,s=i?i.offsetLeft:0,u=i?i.offsetTop:0,a=i?i.offsetParent:0,f=n-s,l=r-u;while(a)f+=a.offsetLeft,l+=a.offsetTop,a=a.offsetParent;return new o(f,l)};var u=function(e,t,n){return this.paper=e,this.start=t,this.end=n,this.wrapper=e.path("M"+this.start.x+","+this.start.y+"L"+this.end.x+","+this.end.y),this};u.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},u.prototype.remove=function(){this.wrapper.remove()},u.prototype.intersection=function(e){var t={x:this.end.x-this.start.x,y:this.end.y-this.start.y},n={x:e.end.x-e.start.x,y:e.end.y-e.start.y},r=t.x*n.y-t.y*n.x,i={x:e.start.x-this.start.x,y:e.start.y-this.start.y},s=i.x*n.y-i.y*n.x,o=i.x*t.y-i.y*t.x;if(r===0||s*r<0||o*r<0)return null;if(r>0){if(s>r||o>r)return null}else if(s<r||o<r)return null;return{x:this.start.x+s*t.x/r,y:this.start.y+s*t.y/r}},u.prototype.findIntersection=function(e){var t=[{p1:e.topLeft,p2:e.topRight},{p1:e.topLeft,p2:e.bottomLeft},{p1:e.bottomLeft,p2:e.bottomRight},{p1:e.bottomRight,p2:e.topRight}];for(var n=0;n<t.length;n++){var r=new u(this.paper,t[n].p1,t[n].p2),i=this.intersection(r);r.remove();if(i)return i}return null};var a=/\s+/,f=t.Events={on:function(e,t,n){var r,i,s;if(!t)return this;e=e.split(a),r=this._callbacks||(this._callbacks={});while(i=e.shift())s=r[i]||(r[i]=[]),s.push(t,n);return this},off:function(e,t,n){var r,i,s,o;if(!(i=this._callbacks))return this;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(a):_.keys(i);while(r=e.shift()){if(!(s=i[r])||!t&&!n){delete i[r];continue}for(o=s.length-2;o>=0;o-=2)t&&s[o]!==t||n&&s[o+1]!==n||s.splice(o,2)}return this},trigger:function(e){var t,n,r,i,s,o,u,f;if(!(n=this._callbacks))return this;f=[],e=e.split(a);for(i=1,s=arguments.length;i<s;i++)f[i-1]=arguments[i];while(t=e.shift()){if(u=n.all)u=u.slice();if(r=n[t])r=r.slice();if(r)for(i=0,s=r.length;i<s;i+=2)r[i].apply(r[i+1]||this,f);if(u){o=[t].concat(f);for(i=0,s=u.length;i<s;i+=2)u[i].apply(u[i+1]||this,o)}}return this}},l=t.Element=function(e){e||(e={}),this.attributes={},this.attributes.children=[]},c=function(e,t){return p(this,e,t)},h=function(){},p=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},_.extend(r,e),h.prototype=e.prototype,r.prototype=new h,t&&_.extend(r.prototype,t),n&&_.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r};l.extend=c,l.prototype={initialize:function(){},has:function(e){return this.attributes[e]!=null},get:function(e){return this.attributes[e]},set:function(e,t){var n;_.isObject(e)?n=e:(n={})[e]=t;for(var r in n)this.attributes[r]=n[r];return this},toJSON:function(){var e=this.attributes,t=_.clone(e);return this._deepClone(t)},_deepClone:function(e){for(var t in e){var n=e[t];if(_.isArray(n)){var r=[];for(var i=0;i<n.length;i++){var s=n[i];s.attributes&&(r[i]=s.toJSON())}e[t]=r}else _.isObject(n)&&n.attributes&&(e[t]=n.toJSON())}return e}},_.extend(t.Element.prototype,t.Events);var d=Raphael._availableAttrs,v=["children","figure","label","compartment"];d.text="";var m=t.DiagramElement=t.Element.extend({constructor:function(e){t.Element.apply(this,[e]),this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.set("id",e.id||_.uniqueId()),this._initAttributes(e)},_initAttributes:function(e){var t;if(!this.figure&&e.figure){for(t in e.figure)_.contains(v,t)||(this.attributes[t]=_.clone(e.figure[t]));this.figure=_.clone(e.figure)}if(this.figure)for(t in this.figure)_.contains(v,t)||(this.attributes[t]=_.clone(this.figure[t]));for(var n in e)_.has(d,n)&&(this.attributes[n]=e[n]);this.has("width")&&this.set("min-width",this.get("width")),this.has("height")&&this.set("min-height",this.get("height"))},render:function(){return this},remove:function(){return this.wrapper&&this.wrapper.remove(),this},paper:function(){!this.diagram&&this.parent&&(this.diagram=this.parent.diagram);if(!this.diagram)throw new Error("Element must be associated to a diagram");return this.diagram.paper()},set:function(e,t){var n;_.isObject(e)?n=e:(n={})[e]=t,this.wrapper&&(this.wrapper.type==="circle"&&(n.x&&(n.cx=n.x),n.y&&(n.cy=n.y)),this.wrapper.attr(n));for(var r in n)this.attributes[r]=n[r];return this},setParent:function(e){return this.parent=e,this.diagram||(this.diagram=e.diagram),this},show:function(){return this.wrapper&&this.wrapper.show(),this},hide:function(){return this.wrapper&&this.wrapper.hide(),this},toFront:function(){return this.wrapper&&this.wrapper.toFront(),this}}),E=function(e,t){this.shape=e,this.type=t.type};E.extend=c,E.prototype={layout:function(){}};var x=t.LayoutElement=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.initialize(e)},bounds:function(){if(this.wrapper)return this.wrapper.getABox();var e=this.get("x"),t=this.get("y"),n=this.get("width"),r=this.get("height");return{x:e,y:t,width:n,height:r}},preferredSize:function(){var e=this.minimumSize(),t=this.get("width"),n=this.get("height");t||(t=this.parent.get("width")),n||(n=this.parent.get("height"));if(this.children){var r=_.reduce(this.children,function(e,t){return e+t.preferredSize().height},0);r>0&&r>n&&(n=r)}return e.width>t&&(t=e.width),e.height>n&&(n=e.height),{width:t,height:n}},minimumSize:function(){var e=this.has("min-width")?this.get("min-width"):this.get("width"),t=this.has("min-height")?this.get("min-height"):this.get("height"),n=this.parent?this.parent.minimumSize():null;return!e&&n&&(e=n.width,this.set("min-width",e)),!t&&n&&(t=n.height,this.set("min-height",t)),{width:e,height:t}},maximumSize:function(){},doLayout:function(){if(!this.layout)return;this.set(this.layout.size()),this.layout.layout()}});t.Diagram=t.Element.extend({constructor:function(e){e||(e={}),t.Element.apply(this,[e]),this._selection=null,this._currentSource=null,this._currentEdge=null,this.set("edges",[]),e.el&&(this.el=e.el),this.el&&this.setElement(this.el),this.initialize(e)},paper:function(){return this._paper||this._initPaper(),this._paper},setElement:function(e){if(!e)return this;if(_.isString(e)){var t=e.indexOf("#")===0?e.slice(1,e.length):e;this.el=document.getElementById(t)}else e instanceof HTMLElement&&(this.el=e);return this},canvas:function(){return this._paper?this._paper.canvas:null},render:function(){var e=this.paper(),t=e.canvas,n=t.clientLeft,r=t.clientTop,i=t.clientWidth,s=t.clientHeight;return this.wrapper=this.paper().rect(n,r,i,s,0).attr({fill:"white",opacity:0,stroke:"none"}),this.setEvents(),_.each(this.get("children"),function(e){e.render()}),_.each(this.get("edges"),function(e){e.render()}),this.on("click",this.deselect,this),this.on("click",this.handleTextInput,this),this},setEvents:function(){if(!this.wrapper)return;var e=this;this.wrapper.click(function(t){e.trigger("click")})},zoom:function(e){},remove:function(){this._paper&&(_.each(this.get("children"),function(e){e.remove()}),_.each(this.get("edges"),function(e){e.remove()}),this._paper.remove(),this._paper=null)},createShape:function(e,t){var n=null,r=t||{};if(!e)throw new Error("Cannot create Shape if Shape constructor is missing.");return r.diagram=this,n=new e(r),n},removeShape:function(e){if(!e)return;var t=this.get("children");this.set("children",_.reject(t,function(t){return t===e})),this.trigger("remove:children",e)},getShape:function(e){if(!e)return null;var t=_.find(this.get("children"),function(t){return t.get("id")===e});return t},createConnection:function(e,t){if(typeof e!="function")return;var n=null,r=t||{},i=r.source,s=r.target;return r.diagram=this,n=new e(r),i&&s&&n.connect(i,s),n.on("remove:source remove:target",function(e){this.removeConnection(e)},this),n},removeConnection:function(e){if(!e)return;var t=this.get("edges");this.set("edges",_.reject(t,function(t){return t===e})),this.trigger("remove:edges",e)},getConnection:function(e){if(!e)return null;var t=_.find(this.get("edges"),function(t){var n=t.get("id");if(n)return n===e});return t},canConnect:function(e){return this.currentEdge?this.currentSource?!0:(this.currentSource=e,!1):!1},connect:function(e){var t=null;return this.currentEdge&&this.currentSource&&(t=this.createConnection(this.currentEdge,{source:this.currentSource,target:e}),this.currentEdge=null,this.currentSource=null),t},handleTextInput:function(){if(!this.inputText)return;var e=this.inputText.value;e&&(this.modifiedLabel.setText(e),this.modifiedLabel.textForm.parentNode.removeChild(this.modifiedLabel.textForm),this.modifiedLabel.textForm=null,this.modifiedLabel=null,this.inputText=null),this.repeatInputClick?this.repeatInputClick=!1:this.repeatInputClick=!0},deselect:function(){this._selection&&typeof this._selection.deselect=="function"&&(this._selection.deselect(),delete this._selection)},setSelection:function(e){this._selection=e},getSelection:function(){return this._selection},parse:function(e){},toJSON:function(){},getElementByPoint:function(e){var t=this.paper(),n=t.getElementByPoint(e.x,e.y);return n&&n.controller?n.controller:null},_initPaper:function(){if(!this.el)throw new Error("Cannot initialize Raphael Object, Diagram Element is missing, use setElement() before.");if(this._paper)return;this._paper=Raphael(this.el,this.width,this.height),this._paper.setViewBox(0,0,this._paper.width,this._paper.height)},_canCreate:function(e){var t=_.find(this.children,function(t){return t===e});return t!==undefined}});var T=t.ToolBox=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.element=e.element,this.width=70,this.height=60},render:function(){if(!this.element&&!this.element.wrapper)return;this.wrapper&&this.wrapper.remove();var e=this.element.paper(),t=this.element.wrapper.getABox(),n=t.xRight-40,r=t.y-30;this.wrapper=e.rect(n,r,this.width,this.height,6).attr({fill:"orange","fill-opacity":0,stroke:"black","stroke-opacity":0,"stroke-width":2}).toBack(),this.wrapper.controller=this,this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),t=this.wrapper.getABox();var i=this;return this.addItem(t.xLeft+20,t.y,N,function(e){i.element.remove(!0)}),this},addItem:function(e,t,n,r){var i=this,s=this.element.paper(),o=s.path(n);return o.attr({fill:"#000",stroke:"none"}),o.attr({cursor:"pointer"}),o.translate(e,t),o.scale(.8,.8),this.get("children").push(o),o.mouseover(function(e){i.isOverChild=!0}),o.mouseout(function(e){e.stopPropagation(),i.isOverChild=!1}),o.click(r),this},remove:function(){this.wrapper&&(this.wrapper.remove(),_.each(this.get("children"),function(e){e.remove()}),this.get("children").length=0)},handleMouseOver:function(){this.controller.isOver=!0},handleMouseOut:function(e){e.stopPropagation()}}),N="M20.826,5.75l0.396,1.188c1.54,0.575,2.589,1.44,2.589,2.626c0,2.405-4.308,3.498-8.312,3.498c-4.003,0-8.311-1.093-8.311-3.498c0-1.272,1.21-2.174,2.938-2.746l0.388-1.165c-2.443,0.648-4.327,1.876-4.327,3.91v2.264c0,1.224,0.685,2.155,1.759,2.845l0.396,9.265c0,1.381,3.274,2.5,7.312,2.5c4.038,0,7.313-1.119,7.313-2.5l0.405-9.493c0.885-0.664,1.438-1.521,1.438-2.617V9.562C24.812,7.625,23.101,6.42,20.826,5.75zM11.093,24.127c-0.476-0.286-1.022-0.846-1.166-1.237c-1.007-2.76-0.73-4.921-0.529-7.509c0.747,0.28,1.58,0.491,2.45,0.642c-0.216,2.658-0.43,4.923,0.003,7.828C11.916,24.278,11.567,24.411,11.093,24.127zM17.219,24.329c-0.019,0.445-0.691,0.856-1.517,0.856c-0.828,0-1.498-0.413-1.517-0.858c-0.126-2.996-0.032-5.322,0.068-8.039c0.418,0.022,0.835,0.037,1.246,0.037c0.543,0,1.097-0.02,1.651-0.059C17.251,18.994,17.346,21.325,17.219,24.329zM21.476,22.892c-0.143,0.392-0.69,0.95-1.165,1.235c-0.474,0.284-0.817,0.151-0.754-0.276c0.437-2.93,0.214-5.209-0.005-7.897c0.881-0.174,1.708-0.417,2.44-0.731C22.194,17.883,22.503,20.076,21.476,22.892zM11.338,9.512c0.525,0.173,1.092-0.109,1.268-0.633h-0.002l0.771-2.316h4.56l0.771,2.316c0.14,0.419,0.53,0.685,0.949,0.685c0.104,0,0.211-0.017,0.316-0.052c0.524-0.175,0.808-0.742,0.633-1.265l-1.002-3.001c-0.136-0.407-0.518-0.683-0.945-0.683h-6.002c-0.428,0-0.812,0.275-0.948,0.683l-1,2.999C10.532,8.77,10.815,9.337,11.338,9.512z",C="M26.834,14.693c1.816-2.088,2.181-4.938,1.193-7.334l-3.646,4.252l-3.594-0.699L19.596,7.45l3.637-4.242c-2.502-0.63-5.258,0.13-7.066,2.21c-1.907,2.193-2.219,5.229-1.039,7.693L5.624,24.04c-1.011,1.162-0.888,2.924,0.274,3.935c1.162,1.01,2.924,0.888,3.935-0.274l9.493-10.918C21.939,17.625,24.918,16.896,26.834,14.693z",k=E.extend({constructor:function(e,t){t||(t={}),E.apply(this,[e,t]),this.columns=t.columns,this.rows=t.rows||0,this.vertical=t.vertical||!1,this.vgap=t.vgap||0,this.hgap=t.hgap||0},layout:function(){if(!this.shape.children||!this.shape.children.length)return;var e=this.shape.children,t=this.shape.bounds(),n=this.rows,r=this.columns||e.length,i=t.x,s=t.y,o,u;n>0?r=Math.floor((e.length+n-1)/n):n=Math.floor((e.length+r-1)/r),o=(t.width-(r-1)*this.hgap)/r,u=(t.height-(n-1)*this.vgap)/n;for(var a=0,f=1;a<e.length;a++,f++)e[a].set({x:i,y:s,width:o,height:u}),this.vertical?f>=n?(i+=o+this.hgap,s=t.y,f=0):s+=u+this.vgap:f>=r?(s+=u+this.vgap,i=t.x,f=0):i+=o+this.hgap,e[a].doLayout()},size:function(){return this.shape.bounds()}}),L=E.extend({constructor:function(e,t){t||(t={}),E.apply(this,[e,t]),this.columns=t.columns||1,this.rows=t.rows||0,this.vertical=t.vertical||!1,this.stretch=t.stretch||!1},layout:function(){if(!this.shape.children||!this.shape.children.length)return;var e=0,t=0,n=0,r=this.shape.children,i=this.rows,s=this.columns,o=this.shape.preferredSize(),u=this.shape.bounds(),a=u.x,f=u.y,l;i>0?s=Math.floor((r.length+i-1)/i):i=Math.floor((r.length+s-1)/s);var c=A([],s),h=A([],i),p=function(e,t){return e+t};for(;e<r.length;e++){n=Math.floor(e/s),t=e%s,l=r[e].preferredSize(),this.stretch?c[t]=o.width:c[t]=l.width;var d,v;this.stretch&&e==r.length-1?(d=_.reduce(h,p,0),v=u.height-d,v>0&&(h[n]=v)):h[n]<l.height&&(h[n]=l.height)}for(;t<s;t++){for(n=0,f=u.y;n<i;n++)e=n*s+t,e<r.length&&(r[e].set({x:a,y:f,width:c[t],height:h[n]}),console.log(r[e],a,f,c[t],h[n]),r[e].doLayout()),f+=h[n];a+=c[t]}},size:function(){var e=this.shape,t=e.children,n=e.bounds(),r=0,i=0,s=0,o=0,u=0,a=this.columns,f=this.rows,l,c,h;f>0?a=Math.floor((t.length+f-1)/f):f=Math.floor((t.length+a-1)/a),c=A([],a),h=A([],f);for(r=0;r<t.length;r++)i=Math.floor(r/a),s=r%a,l=t[r].minimumSize(),c[s]<l.width&&(c[s]=l.width),h[i]<l.height&&(h[i]=l.height);for(r=0;r<a;r++)o+=c[r];for(r=0;r<f;r++)u+=h[r];return n.width>o&&(o=n.width),n.height>u&&(u=n.height),{width:o,height:u}}}),A=function(e,t){var n=0;for(;n<t;n++)e[n]=0;return e},O=E.extend({constructor:function(e,t){t||(t={}),E.apply(this,[e,t]),this.vertical=t.vertical},layout:function(){var e={x:this.shape.get("x"),y:this.shape.get("y")},t=this.shape.bounds(),n=this.shape.children,r,i=[],s={width:0,height:0},o=function(e,t,n,r){var i={x:t.x,y:t.y},o=0,u=e.length;i.x+=(r.width-s.width)/2;for(;o<u;o++)i.y=t.y,e[o].set(i),e[o].doLayout(),i.x+=e[o].bounds().width};_.each(n,function(n){r=n.preferredSize(),s.width+r.width>t.width&&(o(i,s,t),i=[],e.y+=r.height,s.width=0,s.height=0),s.height=Math.max(s.height,r.height),s.width+=r.width,n.set(r),i.push(n)}),o(i,e,r,t)},size:function(){var e=this.shape.bounds(),t=this.shape.children,n=0,r=0,i=0,s=!1,o,u="preferred";if(!t||!t.length)return{width:e.width,height:e.height};for(;n<t.length;n++)o=t[n][u+"Size"](),i=Math.max(i,o.height),r+=o.width;return r<e.width&&(r=e.width),i<e.height&&(i=e.height),{width:r,height:i}}}),M=E.extend({constructor:function(e,t){t||(t={}),E.apply(this,[e,t])},layout:function(){var e=this.shape,t=e.wrapper.getABox(),n=e.children,r=n.length,i=0,s;for(;i<r;i++)s=n[i],s.wrapper.translate(t.x,t.y),s.doLayout()},size:function(){return this.shape.bounds()}}),D=E.extend({constructor:function(e,t){t||(t={}),E.apply(this,[e,t]),this.vgap=t.vgap||0,this.hgap=t.hgap||0},layout:function(){var e=this.shape.bounds(),t=e.y,n=e.bottomLeft.y,r=e.xLeft,i=e.xRight,s;this.north&&(s=this.north.preferredSize(),this.north.set({x:r,y:t,width:i-r,height:s.height}),this.north.doLayout(),t+=s.height+this.vgap),this.south&&(s=this.south.preferredSize(),this.south.set({x:r,y:n-s.height,width:i-r,height:s.height}),this.south.doLayout(),n-=s.height+this.vgap),this.east&&(s=this.east.preferredSize(),this.east.set({x:i-s.width,y:t,width:s.width,height:n-t}),this.east.doLayout(),i-=s.width+this.hgap),this.west&&(s=this.west.preferredSize(),this.west.set({x:r,y:t,width:s.width,height:n-t}),this.west.doLayout(),r+=s.width+this.hgap),this.center&&(this.center.set({x:r,y:t,width:i-r,height:n-t}),this.center.doLayout())},size:function(){return this.shape.bounds()}});t.BoundBox=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.control=e.control,this.control.on("start:move",this.stateMove,this),this.control.on("start:resize",this.stateSize,this),this.control.on("end:move end:resize",this.stateNone,this)},stateMove:function(){this.state="move",this._left="x",this._right="y"},stateSize:function(){this.state="resize",this._left="width",this._right="height"},stateNone:function(){delete this.state},render:function(){this.remove();var e=this.control.paper(),t=this.control.bounds(),n=t.xRight+15,r=t.yMiddle;this.text=e.text(n,r,this.getText());var i=this.text.getABox().width;return this.text.translate(i/2+10,10),this.shadow=e.rect(n,r,i+20,20),this.shadow.attr({fill:"black",opacity:.2,stroke:"none"}),this.shadow.translate(2,2),this.wrapper=e.rect(n,r,i+20,20),this.wrapper.attr({fill:"#FFFF99",opacity:1,stroke:"none"}),this.text.toFront(),this},remove:function(){if(!this.wrapper)return;this.wrapper.remove(),this.shadow.remove(),this.text.remove()},getText:function(){return this.getTemplate()({left:this.control.get(this._left),right:this.control.get(this._right)})},getTemplate:function(){return this.state==="move"?_.template("x: <%= left %>px y: <%= right %>px"):this.state==="resize"?_.template("width: <%= left %>px  height: <%= right %>px"):null}}),t.Selectable={select:function(){var e=this.diagram.getSelection();e&&e.deselect(),this.diagram.setSelection(this);if(this.wrapper){var t=this.wrapper.getABox();this.selectionAnchors=[];var n=new j({box:this}),r=new H({box:this}),i=new B({box:this}),s=new F({box:this}),o=new I({box:this}),u=new q({box:this}),a=new R({box:this}),f=new U({box:this}),l=t.x,c=t.y,h=t.width,p=t.height;this.selectionBox=this.paper().rect(l,c,h,p,0),this.selectionBox.attr(this.selectionStyle),this.selectionBox.toFront(),this.resizable&&(n.render().resizable(),r.render().resizable(),i.render().resizable(),s.render().resizable(),o.render().resizable(),u.render().resizable(),a.render().resizable(),f.render().resizable()),this.selectionAnchors.push(n),this.selectionAnchors.push(r),this.selectionAnchors.push(i),this.selectionAnchors.push(s),this.selectionAnchors.push(o),this.selectionAnchors.push(u),this.selectionAnchors.push(a),this.selectionAnchors.push(f)}},deselect:function(){this._tool&&this._tool.remove(),this.selectionAnchors&&_.each(this.selectionAnchors,function(e){e.remove()}),this.selectionBox&&this.selectionBox.remove()}};var P=t.Anchor=t.DiagramElement.extend({cursor:"none",constructor:function(e){t.DiagramElement.apply(this,[e]),this.box=e.box,this.diagram=this.box.diagram,this.initialize.apply(this,arguments)},initialize:function(e){},render:function(){var e=this.paper();return this.wrapper=e.rect(this.x,this.y,6,6,0).attr(this.box.anchorStyle),this.box.resizable&&this.wrapper.attr({cursor:this.cursor}),this.wrapper.box=this.box.wrapper,this.wrapper.anchor=this,this},remove:function(){this.wrapper&&this.wrapper.remove();if(this.box){var e=this.box;this.box=null,e.anchor&&delete e.anchor}}});P.start=function(){this.o(),this.box.o();var e=this.anchor,t=this.box.controller;t.startResize(),t.boundBox&&t.boundBox.render(),t.shadow&&t.shadowWrapper.remove(),_.each(t.selectionAnchors,function(t){t!==e?t.remove():t.hide()})},P.move=function(e,t,n,r,i){var s=this.box.controller,o=this.anchor.direction,u,a,f;this.attr({x:this.ox+e,y:this.oy+t}),u=s.minimumSize(),a=s.parent?s.parent.bounds():s.paper,f=s.wrapper.rdxy(e,t,o,u,a),s.set(f),s.boundBox&&s.boundBox.render(),s.renderEdges()},P.end=function(){var e=this.box.controller;e.endResize(),e.shadow&&e.createShadow(),e.boundBox&&e.boundBox.remove(),this.anchor&&this.anchor.box.select()};var H=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.x-3,this.y=t.y-3,this.cursor="nw-resize",this.direction="nw"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),B=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xLeft-3,this.y=t.yBottom-3,this.cursor="sw-resize",this.direction="sw"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),j=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-3,this.y=t.y-3,this.cursor="ne-resize",this.direction="ne"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),F=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-3,this.y=t.yBottom-3,this.cursor="se-resize",this.direction="se"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),I=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xCenter-3,this.y=t.y-3,this.cursor="n-resize",this.direction="n"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),q=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xCenter-3,this.y=t.yBottom-3,this.cursor="s-resize",this.direction="s"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),R=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.x-3,this.y=t.yMiddle-3,this.cursor="w-resize",this.direction="w"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),U=P.extend({initialize:function(e){var t=e.box.wrapper.getABox();this.x=t.xRight-3,this.y=t.yMiddle-3,this.cursor="e-resize",this.direction="e"},resizable:function(){return this.wrapper.drag(P.move,P.start,P.end),this}}),z=t.Image=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e])},render:function(){var e=this.paper(),t=this.parent.wrapper.getBBox(),n=this.get("src"),r=this.get("width"),i=this.get("height");return this.wrapper=e.image(n,t.x,t.y,r,i),this.wrapper.toFront(),this.wrapper.controller=this,this},center:function(){var e=this.parent.wrapper.getABox();this.wrapper.attr({x:e.x-this.get("width")}),this.wrapper.attr({y:e.yMiddle-this.get("height")/2})}}),W=["top-left","top-right","top-center","bottom-left","bottom-right","bottom-center","center-left","center-right","center"],V=t.Label=t.LayoutElement.extend({constructor:function(e){t.LayoutElement.apply(this,[e]),this.position=X(this,e),this.resizable=e.resizable||!1,this.draggable=e.draggable||!1,this.editable=e.editable||!0,this.xOffset=5,this.yOffset=5;var n=this.figure?this.figure.image:e.figure.image;n&&this.setImage(n),this.initialize(e)},setImage:function(e){e.parent=this;var n=new t.Image(e);return this.image=n,n},render:function(){this.wrapper&&this.remove();var e=this.paper();return this.wrapper=e.rect().attr({fill:"none",stroke:"none"}),this.attributes.fill&&this.wrapper.attr({fill:this.attributes.fill}),this.label=e.text(0,0,this.get("text")).attr({fill:"black","font-size":12}),this.attributes["font-size"]&&this.label.attr("font-size",this.attributes["font-size"]),this.wrapper.toFront(),this.label.toFront(),this.wrapper.controller=this,console.log("render",this.get("x")),this.doLayout(),this.image&&this.image.render(),this.editable&&this.asEditable(),this},center:function(){var e=this.wrapper.getABox(),t=this.label,n=t.getABox();console.log(this.position,e.xCenter);switch(this.position){case"center":t.attr("x",e.xCenter),t.attr("y",e.yMiddle);break;case"center-left":t.attr("x",e.x+n.width/2+this.xOffset),t.attr("y",e.yMiddle);if(this.image){var r=this.get("x");this.set({x:r+this.image.get("width")})}break;case"center-right":t.attr("x",e.xRight-this.xOffset-n.width/2),t.attr("y",e.yMiddle);break;case"top-center":t.attr("x",e.xCenter),t.attr("y",e.y+n.height/2+this.yOffset);break;case"top-left":t.attr("x",e.x+n.width/2+this.xOffset),t.attr("y",e.y+n.height/2+this.yOffset);break;case"top-right":t.attr("x",e.xRight-this.xOffset-e.width/2),t.attr("y",e.y+e.height/2+this.yOffset);break;case"bottom-center":t.attr("x",e.xCenter),t.attr("y",e.yBottom-e.height/2-this.yOffset);break;case"bottom-left":t.attr("x",e.x+this.xOffset+e.width/2),t.attr("y",e.yBottom-e.height/2-this.yOffset);break;case"bottom-right":t.attr("x",e.x-this.xOffset-e.width/2),t.attr("y",e.yBottom-e.height/2-this.yOffset);break;default:}this.image&&(this.image.set({x:n.x-this.image.get("width")-2}),this.image.set({y:n.y}))},setText:function(e,t){this.set("text",e),this.wrapper&&this.label&&(this.label.attr("text",e),this.doLayout()),t||this.trigger("change:text",this)},getText:function(){return this.get("text")},remove:function(){this.image&&this.image.remove(),this.label&&this.label.remove(),this.wrapper&&this.wrapper.remove()},doLayout:function(){this.center()},preferredSize:function(){return this.label?this.label.getABox():{width:this.get("width"),height:this.get("height")}},minimumSize:function(){return this.label?this.label.getABox():{width:this.get("width"),height:this.get("height")}},asEditable:function(){var e=this;if(!e.label)return;var t=function(e){var t=e.label.getABox(),n=e.wrapper.getABox(),r=e.diagram.el.offsetLeft,i=e.diagram.el.offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=n.width,a=t.height+4,f=e.textForm=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.value=e.get("text"),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},n=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};e.label.dblclick(function(r){var i=e.diagram.modifiedLabel;i&&i!==e&&(n(e.diagram.inputText),n(e.diagram.modifiedLabel.textForm)),e.textForm&&n(e.textForm);var s=t(e);e.textForm=s.form,e.diagram.inputText=s.input,e.diagram.modifiedLabel=e,e.diagram.el.parentNode.appendChild(s.form)})}});_.extend(t.Label.prototype,t.Draggable,t.Events),t.Styles={moveStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},resizeStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},selectStyle:{fill:"none",stroke:"black","stroke-width":1},anchorStyle:{fill:"black",stroke:"none","fill-opacity":1}};var $=t.Shape=t.LayoutElement.extend({connectable:!0,showShadow:!1,resizable:!0,draggable:!0,showToolBox:!0,showBoundBox:!0,constructor:function(e){t.DiagramElement.apply(this,[e]),this.ins=[],this.outs=[],_.isBoolean(e.draggable)&&(this.draggable=e.draggable),_.isBoolean(e.resizable)&&(this.resizable=e.resizable),_.isBoolean(e.showToolBox)&&(this.showToolBox=e.showToolBox),_.isBoolean(e.showBoundBox)&&(this.showBoundBox=e.showBoundBox),e.children&&(this.children=e.children),this.diagram&&!this.parent&&(this.diagram.get("children").push(this),this.diagram.trigger("add:children",this)),this.setUpChildren(),this.setUpLayout(),this.setUpStyles(e),this.setUpToolBox(),this.setUpBoundBox(),this.initialize.apply(this,arguments)},setUpToolBox:function(e){this.showToolBox&&(this.toolBox=new T({element:this}))},setUpBoundBox:function(){this.showBoundBox&&(this.boundBox=new t.BoundBox({control:this}))},setUpStyles:function(e){_.each(_.keys(t.Styles),function(n){e[n]?this[n]=_.clone(e[n]):this[n]=_.clone(t.Styles[n])},this)},render:function(){this.wrapper&&this.remove(!1),this.wrapper=g(this);if(!this.wrapper)throw new Error("Cannot render this shape: ",this);return this.set(this.attributes),this.renderContent(),this.bindEvents(),this.on("click",this.select),this.on("click",this.showTool),this.on("mousedown",this.handleClick),this.on("mouseout",this.removeToolWhenOut),this.draggable&&this.asDraggable(),this},bindEvents:function(){if(!this.wrapper)return;var e=this;this.wrapper.click(function(t){e.trigger("click",t)}),this.wrapper.mouseover(function(t){e.trigger("mouseover",t)}),this.wrapper.mouseout(function(t){e.trigger("mouseout",t)}),this.wrapper.mouseup(function(t){e.trigger("mouseup",t)}),this.wrapper.mousedown(function(t){e.trigger("mousedown",t)})},handleClick:function(e){var t=this.diagram,n=t.currentEdge,r=this;if(!n)return;r.connecting=!0;var i=o.get(t.paper(),e),s=function(e){if(!r.line||!r.connecting)return;var i=t.getElementByPoint(r.line.end);i&&(t.createConnection(n,{source:r,target:i}).render(),delete t.currentEdge),r.line&&(r.line.remove(),delete r.line),r.connecting=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mousemove",s)},a=function(e){if(!r.connecting)return;var n=o.get(t.paper(),e);r.line&&r.line.remove(),r.line=new u(t.paper(),i,n),document.addEventListener("mouseup",s)};document.addEventListener("mousemove",a)},showTool:function(){this._tool&&this._tool.render()},removeToolWhenOut:function(){var e=this;e.toolBox&&window.setTimeout(function(){e.toolBox&&!e.toolBox.isOver&&e.toolBox.remove()},1e3)},remove:function(e){this.deselect(),this.wrapper&&(this.wrapper.remove(),delete this.wrapper),_.each(this.children,function(e){e.remove()}),_.each(this.ins,function(t){t.remove(e)}),_.each(this.outs,function(t){t.remove(e)}),this.shadow&&(this.shadowWrapper.remove(),delete this.shadowWrapper),this.selectionBox&&this.selectionBox.remove(),this.toolBox&&(this.toolBox.remove(),delete this.toolBox),e&&this.diagram.removeShape(this)},disconnect:function(e,t){return e?(!t||t!=="in"&&t!=="out"?(this.ins=_.without(this.ins,e),this.outs=_.without(this.outs,e)):this[t+"s"]=_.without(this[t+"s"],e),this):this},add:function(e){return e.setParent(this),this.children.push(e),this.trigger("add:children",e),this},toJSON:function(){return _.clone(this.attributes)},setUpLayout:function(){this.layout=S(this)},setUpChildren:function(){var e=this.children,n;this.children=[],_.each(e,function(e){b(e)?n=new V(e):y(e)?n=new t.Image(e):w(e)?n=new J(e):n=new $(e),this.add(n)},this)},removeContent:function(){_.each(this.children,function(e){e.remove()})},renderContent:function(){_.each(this.children,function(e){e.render()}),this.doLayout()},renderEdges:function(){_.each(this.ins,function(e){e.render()}),_.each(this.outs,function(e){e.render()})}});t.Resizable={startResize:function(){if(!this.wrapper)return;this._tool&&this.toolBox.remove(),this.wrapper.o(),this.removeContent(),this.wrapper.attr(this.resizeStyle),this.trigger("start:resize")},resize:function(e,t,n){var r,i;return this.resizable?(this.deselect(),this.startResize(),r=this.wrapper.ow+e,i=this.wrapper.oh+t,this.set({width:r,height:i}),this.endResize(),this):this},endResize:function(){this.wrapper.reset(),this.renderEdges(),this.renderContent(),this.trigger("end:resize")}},t.Draggable={asDraggable:function(e){return this.wrapper&&this.wrapper.attr({cursor:"move"}),this.wrapper.drag(this.move,this.startMove,this.endMove),this},startMove:function(){var e=this.wrapper?this:this.controller;if(!e)return;if(e.connecting)return;e.deselect(),e.removeContent();var t=e.wrapper,n=_.clone(t.attrs),r=t.type;t.o(),t.attr(e.moveStyle),t.unmouseover(t.mouseover),t.unmouseout(t.mouseout),e.trigger("start:move")},endMove:function(){var e=this.wrapper?this:this.controller;if(!e)return;e.renderContent();var t=e.wrapper;t.reset(),t.mouseover(this.mouseover),t.mouseout(this.mouseout),e.boundBox&&e.boundBox.remove(),e.trigger("end:move")},move:function(e,t,n,r,i){var s=this.wrapper?this:this.controller;if(!s)return;if(s.connecting)return;if(arguments.length===2){var o=arguments[0],u=arguments[1];return this.startMove(),this.set({x:o,y:u}),this.endMove(),s}return s.set(s.calculatePosition(e,t)),s.boundBox&&s.boundBox.render(),s.renderEdges(),s},calculatePosition:function(e,t){var n=this.wrapper,r=this.parent,i=r?r.bounds():n.paper,s=n.getBBox(),o=n.ox+e,u=n.oy+t,a=function(){return n.is("circle")||n.is("ellipse")},f=a()?s.width/2:0;return r?(o=Math.min(Math.max(i.x+f,o),i.width-(a()?f:s.width)+i.x),u=Math.min(Math.max(i.y+f,u),i.height-(a()?f:s.height)+i.y)):(o=Math.min(Math.max(f,o),i.width-(a()?f:s.width)),u=Math.min(Math.max(f,u),i.height-(a()?f:s.height))),{x:o,y:u,cx:o,cy:u}}},_.extend(t.Shape.prototype,t.Selectable,t.Resizable,t.Draggable,t.Events);var J=t.Compartment=t.Shape.extend({resizable:!1,draggable:!1,layout:"fixed",spacing:5,constructor:function(e){t.Shape.apply(this,[e]),this.accepts=e.accepts||[],this.initialize.apply(this,arguments)},canCreate:function(e){if(!e||typeof e!="function")return!1;var t=_.find(this.accepts,function(t){return t===e});return t?!0:!1},createShape:function(e,t){var n={parent:this},r,i,s;this.layout==="vertical"?(n.x=0,n.y=this._height()):this.layout==="horizontal"?(n.x=this._width(),n.y=0):(i=t.x,s=t.y),r=new e(n),r&&this.children.push(r);var o=this._height(),u=this.get("height");return o>u&&this.set("height",o),this.doLayout(),r},_handleClick:function(e){this.parent&&this.parent.select()},_width:function(){var e=this.children,t=0;return _.each(e,function(e){e.wrapper?t+=e.wrapper.attr("width"):t+=e.get("width")}),t},_height:function(){var e=this.children,t=0;return _.each(e,function(e){e.wrapper?t+=e.wrapper.attr("height"):t+=e.get("height")}),t}});t.arrows={none:function(e){return e||(e=2),{path:"M"+e+",0L"+ -e+",0",dx:e,dy:e,attr:{opacity:0}}},basic:function(e,t){return t||(t=4),{path:["M",t.toString(),"0","L",(-t).toString(),(-t).toString(),"L",(-t).toString(),t.toString(),"z"],dx:t,dy:t,attr:{stroke:"black",fill:"black"}}}};var K=t.ConnectionAnchor=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.connection=e.connection,this.diagram=this.connection.diagram},move:function(e){return this.x=e.x,this.y=e.y,this.wrapper&&this.wrapper.attr({x:this.x-2,y:this.y-2}),this},render:function(){if(this.wrapper)return this;var e=this.paper();return this.wrapper=e.rect(this.x-3,this.y-3,6,6),this.wrapper.attr({fill:"black",stroke:"none"}),this.wrapper.anchor=this,this.asDraggable(),this},remove:function(){this.wrapper&&this.wrapper.remove()},asDraggable:function(){var e=function(e,t){this.attr({x:this.ox+e,y:this.oy+t}),this.anchor.connection.state="dragging",this.anchor.connection.dragger=this.anchor,this.anchor.connection.render()},t=function(){this.o(),this.anchor.shape.disconnect(this.anchor.connection)},n=function(){var e=this.paper,t=e.getElementsByPoint(this.attr("x"),this.attr("y")),n=_.find(t,function(e){return e!==this.anchor&&e.controller},this);n&&(this.anchor.shape=n.controller),this.anchor.connection.state=null;var r=this.anchor.connection.get("targetAnchor")===this.anchor;r?this.anchor.connection.connect(this.anchor.connection.get("sourceAnchor").shape,this.anchor.shape):this.anchor.connection.connect(this.anchor.shape,this.anchor.connection.get("targetAnchor").shape),this.anchor.connection.render()};return this.wrapper.drag(e,t,n),this},attach:function(e){return this.shape=e,this},toJSON:function(){return this.set("x",this.wrapper.x()),this.set("y",this.wrapper.y()),this._deepClone(this.attributes)}}),Q=function(e,t,n,r,i){this.paper=e,this.point=t,this.angle=n,this.radians=r,this.attributes={},this.attributes.attr={};if(i){this.attributes.type=i.type;var s=Raphael._availableAttrs;for(var o in i)_.has(s,o)&&(this.get("attr")[o]=i[o])}return this};_.extend(Q.prototype,t.Element.prototype),Q.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},Q.prototype.render=function(){var e=this.get("type");if(!e||e==="none")return this;var n;typeof t.arrows[e]=="function"?n=t.arrows[e](this.point):n=t.arrows.basic(this.point);var r=this.point.x+ -1.5*(n.dx-1)*Math.cos(this.radians),i=this.point.y+1.5*(n.dy-1)*Math.sin(this.radians);return this.wrapper=this.paper.path(n.path.join(" ")),this.wrapper.attr(n.attr),this.wrapper.attr(this.get("attr")),this.wrapper.translate(r,i),this.wrapper.rotate(this.angle),this};var G=t.ConnectionLabel=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]);if(!e.connection)throw new Error("ConnectionLabel must have a parent Connection");this.connection=e.connection,this.diagram=this.connection.diagram,this.position=e.position,this.set("text",e.text)},remove:function(){this.wrapper&&this.wrapper.remove()},render:function(){this.remove();var e=this.paper(),t=this.connection,n=this.wrapper=e.text(0,0,this.get("text")),r=function(e,t,n,r){var i=t.xCenter<n,s=t.yMiddle>r,o=e.getBBox(),u=i?10+o.width/2:10-o.width,a=s?-10:10;return{x:n+u,y:r+a}},i=function(){var e=t.get("targetAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle,a=Math.sqrt(o*o+u*u),f=Math.atan(u/o);return r(n,i,o,u)},s=function(){var e=t.get("sourceAnchor"),i=e.shape.wrapper.getABox(),s=e.wrapper.getABox(),o=s.xCenter,u=s.yMiddle;return r(n,i,o,u)},o=function(){var e=t.get("sourceAnchor"),n=t.get("targetAnchor"),r=e.wrapper.getABox(),i=n.wrapper.getABox(),s=r.xCenter,o=r.yMiddle,u=i.xCenter,a=i.yMiddle,f=(s+u)/2,l=(o+a)/2;return l-=10,{x:f,y:l}},u;switch(this.position){case"start":u=s();break;case"end":u=i();break;default:u=o()}return this.wrapper.transform(["t",u.x,",",u.y].join("")),this.asEditable().asDraggable(),this},setText:function(e){this.set("text",e),this.trigger("change:text",e),this.wrapper&&this.wrapper.attr("text",e)},asDraggable:function(){var e=function(){this.o()},t=function(){},n=function(e,t,n,r,i){var s=this.ox+e,o=this.oy+t;this.attr({x:s,y:o})};return this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(n,e,t)),this},asEditable:function(){var e=this,t=this.connection.diagram;if(!e.wrapper)return;var n=function(e){var t=e.wrapper.getABox(),n=e.connection.diagram,r=n.canvas().offsetLeft,i=n.canvas().offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=t.width+20,a=20,f=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("placeholder",e.wrapper.attr("text")),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},r=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};return e.wrapper.dblclick(function(i){var s=t.modifiedLabel;s&&s!==e&&(r(t.inputText),r(t.modifiedLabel.textForm)),e.textForm&&r(e.textForm);var o=n(e);e.textForm=o.form,t.inputText=o.input,t.modifiedLabel=e,t.canvas().parentNode.appendChild(o.form)}),this}}),Y=t.Connection=t.DiagramElement.extend({toolbox:!0,constructor:function(e){t.DiagramElement.apply(this,[e]),this.set("sourceAnchor",new K({connection:this})),this.set("targetAnchor",new K({connection:this})),this.vertices=[],this.labels=_.map(this.labels||[],function(e){return new G({connection:this,position:e.position,text:e.text})},this),this.toolbox&&(this._tool=new T({element:this})),this.diagram&&(this.diagram.get("edges").push(this),this.diagram.trigger("add:edges",this)),this.initialize.apply(this,arguments)},initialize:function(){},addPoint:function(e){var t=new Z(this,e);return this.vertices.push(t),this.vertices=_.sortBy(this.vertices,function(e){return e.x}),this.render(),this},remove:function(e){return this.wrapper&&this.wrapper.remove(),this.dummy&&this.dummy.remove(),this.startArrow&&this.startArrow.remove(),this.endArrow&&this.endArrow.remove(),this._tool&&this._tool.remove(),this.labels&&_.each(this.labels,function(e){e.remove()}),_.each(this.vertices,function(e){e.state||e.remove()}),e&&(this.disconnect(),this.get("sourceAnchor").remove(),this.get("targetAnchor").remove(),this.diagram.removeConnection(this)),this.off("click",this._handleClick),this.off("dblclick",this._createFlexPoint),this},render:function(){var e=this._boxes(),t=e[0],n=e[1],r=this._points(t,n),i=r[0],s=r[1],o,u,a;if(!i||!s)return this;this.remove(),this.vertices.length?o=tt(this.vertices[this.vertices.length-1],n.center):o=tt(t.center,n.center),u=360-o.degrees+180,a=360-o.degrees,this.get("sourceAnchor").move(i).render().hide(),this.get("targetAnchor").move(s).render().hide();var f=et(this.get("sourceAnchor"),this.get("targetAnchor"),this.vertices,!1),l=this.paper();this.wrapper=l.path(f.join(" ")),this.wrapper.attr(this.attributes),this.wrapper.controller=this,this.startArrow=new Q(l,i,u,o.radians,this.start),this.startArrow.render(),this.endArrow=new Q(l,s,a,o.radians,this.end),this.endArrow.render(),this.dummy=l.path(f.join(" ")),this.dummy.connection=this,this.dummy.attr({cursor:"pointer",fill:"none",opacity:0,"stroke-width":8});var c=this;return this.dummy.dblclick(function(e){c.trigger("dblclick",e)}),this.dummy.click(function(e){c.trigger("click",e)}),this.on("click",this._handleClick),this.on("dblclick",this._createFlexPoint),this.labels&&_.each(this.labels,function(e){e.render()}),this},_handleClick:function(e){var t=this._tool,n=this.diagram;this.select(),t&&t.render(),n.selected&&n.selected.deselect()},_createFlexPoint:function(e){this.addPoint({x:e.clientX,y:e.clientY}),this.select()},select:function(){this.get("sourceAnchor").toFront().show(),this.get("targetAnchor").toFront().show(),_.each(this.vertices,function(e){e.render()}),this.trigger("select")},deselect:function(){this.get("sourceAnchor").toFront().hide(),this.get("targetAnchor").toFront().hide(),_.each(this.vertices,function(e){e.remove()}),this.trigger("deselect")},connect:function(e,t){return!e||!t?this:(this.set("source",e),this.set("target",t),this.get("sourceAnchor").attach(e),this.get("targetAnchor").attach(t),e.trigger("connect:source",this),t.trigger("connect:target",this),this.trigger("connect"),e.outs.push(this),t.ins.push(this),this)},disconnect:function(){var e=this.get("source"),t=this.get("target");return e&&e.disconnect(this,"out"),t&&t.disconnect(this,"in"),this.set("source",null),this.set("target",null),this.trigger("disconnect"),this},toJSON:function(){var e={};return e.source=this.get("source").get("id"),e.target=this.get("target").get("id"),e.type=this.get("type"),e.id=this.get("id"),e.sourceAnchor=this.get("sourceAnchor"),e.targetAnchor=this.get("targetAnchor"),e.x=this.get("x"),e.y=this.get("y"),this.wrapper&&(e.attr=this.wrapper.attr()),e},_boxes:function(){var e=this.paper(),t,n;return this.state&&this.state==="dragging"?this.dragger===this.get("sourceAnchor")?(t=this.get("sourceAnchor").wrapper.getABox(),n=this.get("target").wrapper.getABox()):(t=this.get("source").wrapper.getABox(),n=this.get("targetAnchor").wrapper.getABox()):(t=this.get("source").wrapper.getABox(),n=this.get("target").wrapper.getABox()),[t,n]},_points:function(e,t){var n=this.paper(),r,i,s;return this.vertices.length?(r=new u(n,e.center,this.vertices[0]),i=r.findIntersection(e),r.remove(),r=new u(n,this.vertices[this.vertices.length-1],t.center),s=r.findIntersection(t),r.remove()):(r=new u(n,e.center,t.center),i=r.findIntersection(e),s=r.findIntersection(t),r.remove()),[i,s]}});_.extend(t.Connection.prototype,t.Events),Z.prototype.render=function(){return this.remove(),this.wrapper=this.paper.rect(this.x-3,this.y-3,6,6,0),this.wrapper.attr({fill:"black",stroke:"none",cursor:"pointer"}),this.drag(),this.wrapper.toFront(),this},Z.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},Z.prototype.drag=function(){if(!this.wrapper)return this;var e=this,t=this.connection,n=function(n,r){this.attr({x:this.ox+n,y:this.oy+r});var i=this.getABox();e.x=i.center.x,e.y=i.center.y,t.render()},r=function(){this.o(),e.state="dragging",this.attr("cursor","move")},i=function(){delete e.state,t.deselect()};this.wrapper.drag(n,r,i)};var nt=t.Palette=function(e){this.diagram=e,this.paletteX=10,this.paletteY=10};nt.extend=c,nt.prototype.render=function(){if(this.element)return this;var e=this.diagram;this.element=document.createElement("div"),this.element.setAttribute("class","palette"),this.element.style.left=this.paletteX,this.element.style.top=this.paletteY;var t=document.createElement("div");t.setAttribute("class","palette-inner"),this.header=document.createElement("div"),this.header.setAttribute("class","palette-header");var n=document.createElement("div");return this.header.appendChild(n),this.body=document.createElement("div"),this.body.setAttribute("class","palette-body"),_.each(this.groups,function(e){var t=new rt(e,this);t.render(),this.body.appendChild(t.el())},this),this.element.appendChild(t),t.appendChild(this.header),t.appendChild(this.body),this.diagram.el.appendChild(this.element),this},nt.prototype.el=function(){return this.element},nt.prototype.asDraggable=function(){if(this.element&&this.header){this.header.style.cursor="move";var e=this;this.header.addEventListener("mousedown",function(t){function n(t){var n=e.element.style.position;e.element.style.position="absolute",e.element.style.left=t.clientX+window.pageXOffset-e.innerX+"px",e.element.style.top=t.clientY+window.pageYOffset-e.innerY+"px",e.element.style.position=n}e.innerX=t.clientX+window.pageXOffset-e.element.offsetLeft,e.innerY=t.clientY+window.pageYOffset-e.element.offsetTop,window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",function(){window.removeEventListener("mousemove",n,!1)},!0)})}},nt.prototype.remove=function(){this.element&&(this.element.parentNode.removeChild(this.element),this.element=null)};var rt=function(e,t){this.title=e.title,this.tools=e.tools,this.palette=t,this.views=[]};rt.prototype.template=_.template('<div class="palette-header"><span> <%= title %></span></div><div class="palette-body"></div>'),rt.prototype.render=function(){function n(e,t){var r;if(!e)return;return typeof e.canCreate=="function"&&e.canCreate(t)&&(r=e),r||(r=_.find(e.children,function(e){return n(e,t)!==undefined})),r}function r(i){var s=t.palette.currentItem,u,a;if(s){u=o.get(e._paper,i);if(typeof s.shape=="function")if(e._canCreate(t.palette.currentItem.shape))a=e.createShape(s.shape,u),a&&(a.render(),t.palette.currentItem.trigger("created"));else{var f=e.paper().getElementsByPoint(u.x,u.y);if(f&&f.length){var l=f.length,c=0,h,p,d;while(c<l&&!h)p=f[c],d=p.controller,h=n(d,s.shape),c++;h&&(a=new s.shape(u),a&&(h.add(a),h.renderContent(),h.doLayout(),t.palette.currentItem.trigger("created")))}}}e.el.removeEventListener("click",r,!1)}this.remove(),this.element=document.createElement("div"),this.element.setAttribute("class","palette-group"),this.element.innerHTML=this.template(this),this.header=this.element.children[0],this.body=this.element.children[1],_.each(this.tools,function(t){var n=new it(t,this.palette);n.render(),n.on("click",function(){this.palette.currentItem=n,typeof n.edge=="function"?e.currentEdge=n.edge:e.el.addEventListener("click",r,!1)},this),n.on("created",function(){this.palette.currentItem=null},this),this.views.push(n),this.body.appendChild(n.el())},this);var e=this.palette.diagram,t=this;return this.header.addEventListener("click",function(e){t._hidden?(t.show(),t._hidden=!1):(t.hide(),t._hidden=!0)}),this},rt.prototype.el=function(){return this.element},rt.prototype.hide=function(){return _.each(this.views,function(e){e.remove()}),this},rt.prototype.show=function(){return _.each(this.views,function(e){e.render(),this.body.appendChild(e.el())},this),this},rt.prototype.remove=function(){return this.element&&this.element.parentNode.removeChild(this.element),this};var it=function(e,t){this.icon=e.icon||"icon-tool-"+e.title,this.title=e.title,this.shape=e.shape,this.edge=e.edge,this.palette=t};_.extend(it.prototype,f),it.prototype.template=_.template('<span><i class="<%= icon %>"></i> <%= title %></span>'),it.prototype.render=function(){this.remove(),this.element=document.createElement("div"),this.element.setAttribute("class","palette-item");var e=this.template(this);this.element.innerHTML=e;var t=this;return t.element.addEventListener("click",function(e){e.stopPropagation(),t.trigger("click")},!1),this.element.addEventListener("mouseover",function(e){t.element.setAttribute("class","palette-item highlight")}),this.element.addEventListener("mouseout",function(e){t.element.setAttribute("class","palette-item")}),this},it.prototype.remove=function(){this.element&&(this.element.parentNode.removeChild(this.element),delete this.element)},it.prototype.el=function(){return this.element}})(window);