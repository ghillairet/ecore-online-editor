(function(e){"use strict";function E(e){return e.figure&&e.figure.type==="image"}function S(e){return e.figure&&e.figure.type==="text"}function T(e){return e.compartment===!0}function W(e,t){this.connection=e,this.paper=e.paper(),this.x=t.x,this.y=t.y}function V(e,t,n,r){var i=["M",e.x,e.y],s=0,o=n.length;for(;s<o;s++)i.push("L",n[s].x,n[s].y);return i.push("L",t.x,t.y),i}var t={version:"0.1.0"};e.Ds=t;var n=function(e){return _.isNumber(e)&&_.isFinite(e)?e>0:!1};Raphael.el.is=function(e){return this.type===e},Raphael.el.x=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cx");default:return this.attr("x")}},Raphael.el.y=function(){switch(this.type){case"ellipse":case"circle":return this.attr("cy");default:return this.attr("y")}},Raphael.el.o=function(){var e=this.attr();return this.oa=_.clone(e),this.oa.fill=this.attr("fill"),this.oa["fill-opacity"]===undefined&&(this.oa["fill-opacity"]=1),this.ox=this.x(),this.oy=this.y(),this.ow=e.width,this.oh=e.height,this.or=e.r,this.orx=e.rx,this.ory=e.ry,this},Raphael.el.reset=function(){var e=this.oa;return e?(e.width=this.attrs.width,e.height=this.attrs.height,e.r=this.attrs.r,e.cx=this.attrs.cx,e.cy=this.attrs.cy,e.x=this.attrs.x,e.y=this.attrs.y,this.attr(e),delete this.oa,this):this},Raphael.el.getABox=function(){var e=this.getBBox(),t={x:e.x,y:e.y,width:e.width,height:e.height,xLeft:e.x,xCenter:e.x+e.width/2,xRight:e.x+e.width,yTop:e.y,yMiddle:e.y+e.height/2,yBottom:e.y+e.height};return t.center={x:t.xCenter,y:t.yMiddle},t.topLeft={x:t.xLeft,y:t.yTop},t.topRight={x:t.xRight,y:t.yTop},t.bottomLeft={x:t.xLeft,y:t.yBottom},t.bottomRight={x:t.xRight,y:t.yBottom},t.top={x:t.xCenter,y:t.yTop},t.bottom={x:t.xCenter,y:t.yBottom},t.left={x:t.xLeft,y:t.yMiddle},t.right={x:t.xRight,y:t.yMiddle},t},Raphael.fn.polyline=function(e,t){var n=["M",e,t,"L"];for(var r=2;r<arguments.length;r++)n.push(arguments[r]);return this.path(n.join(" "))},Raphael.fn.triangle=function(e,t,n){var r=["M",e,t];return r=r.concat(["L",e+n/2,t+n]),r=r.concat(["L",e-n/2,t+n]),this.path(r.concat(["z"]).join(" "))},t.Styles={moveStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},resizeStyle:{fill:"grey","fill-opacity":.2,"stroke-width":0},selectStyle:{fill:"none",stroke:"black","stroke-width":1},anchorStyle:{fill:"black",stroke:"none","fill-opacity":1}};var r=t.Point=function(t,n){!n&&_.isObject(t)?(this.x=t.x,this.y=t.y):(this.x=t,this.y=n)};r.prototype.isInside=function(e){return e&&e.x?this.x>=e.x&&this.x<=e.xRight&&this.y>=e.y&&this.y<=e.yBottom:!1},r.prototype.theta=function(e){return r.theta(this,e)},r.prototype.vector=function(e){return r.vector(this,e)},r.prototype.add=function(e){this.x+=e.y,this.y+=e.y},r.prototype.sub=function(e){this.x-=e.x,this.y-=e.y},r.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},r.theta=function(e,t){var n=-(t.y-e.y),r=t.x-e.x,i=Math.atan2(n,r);return i<0&&(i=2*Math.PI+i),{degrees:180*i/Math.PI,radians:i}},r.vector=function(e,t){return{x:t.x-e.x,y:t.y-e.y}},r.get=function(e,t){if(window.event&&window.event.contentOverflow!==undefined)return new r(window.event.x,window.event.y);if(t.offsetX!==undefined&&t.offsetY!==undefined)return new r(t.offsetX,t.offsetY);var n=e.paper?e.paper():e,i=t.pageX,s=t.pageY,o=n.canvas.parentNode,u=0,a=0;while(o&&!isNaN(o.offsetLeft)&&!isNaN(o.offsetTop))u+=o.offsetLeft-o.scrollLeft,a+=o.offsetTop-o.scrollTop,o=o.offsetParent;return u=t.pageX-u,a=t.pageY-a,new r(u,a)};var i=function(e,t,n){return this.paper=e,this.start=t,this.end=n,this.wrapper=e.path("M"+this.start.x+","+this.start.y+"L"+this.end.x+","+this.end.y),this};i.prototype.attr=function(){return Raphael.el.attr.apply(this.wrapper,arguments)},i.prototype.remove=function(){this.wrapper.remove()},i.prototype.intersection=function(e){var t={x:this.end.x-this.start.x,y:this.end.y-this.start.y},n={x:e.end.x-e.start.x,y:e.end.y-e.start.y},r=t.x*n.y-t.y*n.x,i={x:e.start.x-this.start.x,y:e.start.y-this.start.y},s=i.x*n.y-i.y*n.x,o=i.x*t.y-i.y*t.x;if(r===0||s*r<0||o*r<0)return null;if(r>0){if(s>r||o>r)return null}else if(s<r||o<r)return null;return{x:this.start.x+s*t.x/r,y:this.start.y+s*t.y/r}},i.prototype.findIntersection=function(e){var t=[{p1:e.topLeft,p2:e.topRight},{p1:e.topLeft,p2:e.bottomLeft},{p1:e.bottomLeft,p2:e.bottomRight},{p1:e.bottomRight,p2:e.topRight}];for(var n=0;n<t.length;n++){var r=new i(this.paper,t[n].p1,t[n].p2),s=this.intersection(r);r.remove();if(s)return s}return null};var s=/\s+/,o=t.Events={on:function(e,t,n){var r,i,o;if(!t)return this;e=e.split(s),r=this._callbacks||(this._callbacks={});while(i=e.shift())o=r[i]||(r[i]=[]),o.push(t,n);return this},off:function(e,t,n){var r,i,o,u;if(!(i=this._callbacks))return this;if(!(e||t||n))return delete this._callbacks,this;e=e?e.split(s):_.keys(i);while(r=e.shift()){if(!(o=i[r])||!t&&!n){delete i[r];continue}for(u=o.length-2;u>=0;u-=2)t&&o[u]!==t||n&&o[u+1]!==n||o.splice(u,2)}return this},trigger:function(e){var t,n,r,i,o,u,a,f;if(!(n=this._callbacks))return this;f=[],e=e.split(s);for(i=1,o=arguments.length;i<o;i++)f[i-1]=arguments[i];while(t=e.shift()){if(a=n.all)a=a.slice();if(r=n[t])r=r.slice();if(r)for(i=0,o=r.length;i<o;i+=2)r[i].apply(r[i+1]||this,f);if(a){u=[t].concat(f);for(i=0,o=a.length;i<o;i+=2)a[i].apply(a[i+1]||this,u)}}return this}},u=t.Element=function(e){this.attributes={},this.attributes.children=[]},a=function(e,t){return l(this,e,t)},f=function(){},l=function(e,t,n){var r;return t&&t.hasOwnProperty("constructor")?r=t.constructor:r=function(){e.apply(this,arguments)},_.extend(r,e),f.prototype=e.prototype,r.prototype=new f,t&&_.extend(r.prototype,t),n&&_.extend(r,n),r.prototype.constructor=r,r.__super__=e.prototype,r};u.extend=a,u.prototype={initialize:function(){},has:function(e){return this.attributes[e]!=null},get:function(e){return this.attributes[e]},set:function(e,t){var n;_.isObject(e)?n=e:(n={})[e]=t;for(var r in n)this.attributes[r]=n[r];return this},toJSON:function(){var e=this.attributes,t=_.clone(e);return this._deepClone(t)},_deepClone:function(e){for(var t in e){var n=e[t];if(_.isArray(n)){var r=[];for(var i=0;i<n.length;i++){var s=n[i];s.attributes&&(r[i]=s.toJSON())}e[t]=r}else _.isObject(n)&&n.attributes&&(e[t]=n.toJSON())}return e}},_.extend(t.Element.prototype,t.Events);var c=Raphael._availableAttrs,h=["children","figure","label","compartment"];c.text="";var p=t.Figure=t.Element.extend({constructor:function(e){e||(e={}),t.Element.apply(this,[e]),e.shape?this.shape=e.shape:e.paper&&(this.paper=e.paper),this.eveHandlers=[]},initialize:function(e){},set:function(e,t){var n;_.isObject(e)?n=e:(n={})[e]=t;for(var r in n)this.setValue(r,n[r]);return this},setValue:function(e,t){_.has(this.defaults,e)&&(this.attributes[e]=t,this.setMinValues(e,t),this.wrapper&&this.wrapper.attr(e,t))},setMinValues:function(e,t){(e==="width"||e==="height")&&!this.attributes["min"+e]&&(this.attributes["min-"+e]=t)},render:function(){},events:["click","dblclick","mouseover","mouseout","mouseup","mousedown","mousemove","touchmove","touchstart","touchend"],bindEvents:function(e){var t=this.shape,n=e||this.wrapper;this.eveHandlers=_.map(this.events,function(e){return{eve:e,handler:function(n){t.trigger(e,n)}}}),_.each(this.eveHandlers,function(e){n[e.eve](e.handler)})},unBindEvents:function(e){var t=e||this.wrapper;_.each(this.eveHandlers,function(e){t["un"+e.eve](e.handler)}),this.eveHandlers.length=0},renderer:function(){this.diagram||(this.diagram=this.shape.diagram||this.shape.parent.diagram);var e=this.diagram.paper();if(!e)throw new Error("Cannot render figure, renderer is not available.");return e},startResize:function(e){this.wrapper&&(this.wrapper.o(),this.wrapper.attr(e))},resize:function(e,t,n){},endResize:function(){this.wrapper&&this.wrapper.reset()},asDraggable:function(e){this.moveStyle=e,this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(this.move,this.startMove,this.endMove))},startMove:function(e){var t=this.control;if(!t)return;var n=t.shape;if(n.connecting)return;n.deselect(),n.removeContent();var r=_.clone(this.attrs);this.o(),this.attr(n.moveStyle),n.trigger("start:move")},move:function(e,t,n,r,i){var s=this.control||this;if(!s)return;var o=s.shape;if(o.connecting)return;var u=s.calculatePosition(e,t);s.set({x:u.x,y:u.y}),s.shape.renderEdges(),o.boundBox&&o.boundBox.render()},endMove:function(){var e=this.control;if(!e)return;var t=e.shape;t.renderContent(),this.reset(),t.boundBox&&t.boundBox.remove(),t.renderEdges(),t.trigger("end:move")},calculateX:function(e){var t=this.bounds(),n=this.limits(),r=this.wrapper.ox+e;return Math.min(Math.max(0,r),n.width-t.width)},calculateY:function(e){var t=this.bounds(),n=this.limits(),r=this.wrapper.oy+e;return Math.min(Math.max(0,r),n.height-t.height)},calculatePosition:function(e,t){return{x:this.calculateX(e),y:this.calculateY(t)}},bounds:function(){return this.wrapper?this.wrapper.getABox():{x:this.get("x"),y:this.get("y")}},limits:function(){var e=this.shape;if(this.shape.parent)return this.shape.parent.bounds();var t=this.renderer();return{x:0,y:0,width:t.width,height:t.height}},remove:function(){return this.wrapper&&(this.wrapper.remove(),this.unBindEvents(),delete this.wrapper),this},translate:function(e,t){return this.wrapper&&(this.wrapper.transform("t"+e+","+t),this.attributes.x=this.wrapper.attr("x"),this.attributes.y=this.wrapper.attr("y")),this},isPointInside:function(e){var t=e.x,n=e.y,r=this.wrapper.getABox();return t>=r.x&&t<=r.xRight&&n>=r.y&&n<=r.yBottom},show:function(){this.wrapper&&this.wrapper.show()},hide:function(){this.wrapper&&this.wrapper.hide()},toFront:function(){this.wrapper&&this.wrapper.toFront()},toBack:function(){this.wrapper&&this.wrapper.toBack()},preferredSize:function(){return this.bounds()},minimumSize:function(){return this.bounds()},maximumSize:function(){return this.bounds()}},{defaults:{x:0,y:0,fill:"none",opacity:1,stroke:"none","fill-opacity":1,"stroke-opacity":1,"stroke-width":1,cursor:"default"},figures:{rect:"Rectangle",circle:"Circle",ellipse:"Ellipse",path:"Path",text:"Text"},create:function(e,n){if(!e||!n)return;var r=n.type,i=p.figures[r],s={shape:e,figure:n};if(r&&i)return typeof i=="function"?new i(s):new t[i](s)}}),d=t.Rectangle=t.Figure.extend({constructor:function(e){e||(e={}),t.Figure.apply(this,[e]),this.defaults=_.extend({},d.defaults),this.attributes=_.extend({},this.defaults,e.figure||e),this.initialize(e)},bounds:function(){return this.wrapper?this.wrapper.getABox():{width:this.get("width"),height:this.get("height"),x:this.get("x"),y:this.get("y")}},render:function(){this.remove();var e=this.renderer();return this.wrapper=e.rect(this.get("x"),this.get("y"),this.get("width"),this.get("height"),this.get("r")),this.wrapper.attr(this.attributes),this.wrapper.control=this,this.bindEvents(),this},resize:function(e,t,n){var r=this.minimumSize(),i=this.limits(),s=this.wrapper.ox,o=this.wrapper.oy,u=this.wrapper.ow,a=this.wrapper.oh;n!=="n"&&n!=="s"&&(u=this.wrapper.ow+e),n!=="w"&&n!=="e"&&(a=this.wrapper.oh+t),_.include(["sw","nw","w"],n)&&(u=this.wrapper.ow-e,u<r.width&&(e-=r.width-u),s=this.wrapper.ox+e),_.include(["ne","nw","n"],n)&&(a=this.wrapper.oh-t,a<r.height&&(t-=r.height-a),o=this.wrapper.oy+t),a<r.height&&(a=r.height),u<r.width&&(u=r.width),u>i.width&&(u=i.width),a>i.height&&(a=i.height),s<i.x&&(s=i.x),o<i.y&&(o=i.y),this.set({width:u,height:a,y:o,x:s})},minimumSize:function(){var e=this.get("min-width"),t=this.get("min-height");return e||(e=this.get("width")),t||(t=this.get("height")),{width:e,height:t}}},{defaults:_.extend({},p.defaults,{width:0,height:0,r:0})}),v=t.Circle=t.Figure.extend({constructor:function(e){e||(e={}),t.Figure.apply(this,[e]),this.attributes=_.extend({},v.defaults,e.figure),this.defaults=v.defaults,this.initialize(e)},setValue:function(e,t){if(_.has(this.defaults,e)){this.attributes[e]=t;if(e==="x"||e==="y")e="c"+e;e==="r"&&(this.attributes["min-r"]||(this.attributes["min-r"]=t)),this.wrapper&&this.wrapper.attr(e,t)}},bounds:function(){return this.wrapper?this.wrapper.getABox():{width:this.get("width"),height:this.get("height"),x:this.get("x"),y:this.get("y")}},render:function(){this.remove();var e=this.renderer();if(!e)throw new Error("Cannot render figure, renderer is not available.");return this.wrapper=e.circle(this.get("x"),this.get("y"),this.get("r")),this.wrapper.attr(this.attributes),this.wrapper.control=this,this.bindEvents(),this},resize:function(e,t,r){_.include(["ne","nw","n"],r)&&(t=-t);var i=this.minimumSize(),s=this.wrapper.or+(t<0?-1:1)*Math.sqrt(2*t*t),o=n(s)?s:this.wrapper.or;o<i.r&&(o=i.r),this.set({r:o})},calculateX:function(e,t){var n=this.bounds(),r=t?t.bounds():this.wrapper.paper,i=this.wrapper.ox+e,s=n.width/2;return t?Math.min(Math.max(r.x+s,i),r.width-s+r.x):Math.min(Math.max(s,i),r.width-s)},calculateY:function(e,t){var n=this.bounds(),r=t?t.bounds():this.wrapper.paper,i=this.wrapper.oy+e,s=n.width/2;return t?Math.min(Math.max(r.y+s,i),r.height-s+r.y):Math.min(Math.max(s,i),r.height-s)},minimumSize:function(){return{r:this.get("min-r")}},translate:function(e,t){return this.wrapper&&(this.wrapper.transform("t"+e+","+t),this.set({x:this.wrapper.attr("cx"),y:this.wrapper.attr("cy")})),this}},{defaults:_.extend({},p.defaults,{r:0})}),m=t.Ellipse=t.Figure.extend({constructor:function(e){e||(e={}),t.Figure.apply(this,[e]),this.attributes=_.extend({},m.defaults,e.figure),this.defaults=m.defaults,this.initialize(e)},render:function(){var e=this.renderer();return this.wrapper=e.ellipse(),this.wrapper.control=this,this.wrapper.attr(this.attributes),this},resize:function(e,t,r){_.include(["ne","nw","n"],r)&&(t=-t),_.include(["nw","sw","n"],r)&&(e=-e);var i=this.wrapper.orx+e,s=this.wrapper.orx+t;this.set({rx:n(i)?i:this.wrapper.orx,ry:n(s)?s:this.wrapper.ory})}},{defaults:_.extend({},p.defaults,{})}),g=t.Path=t.Figure.extend({constructor:function(e){e||(e={}),t.Figure.apply(this,[e]),this.attributes=_.extend({},e.figure),this.defaults=p.defaults,this.initialize(e)},render:function(){this.remove();var e=this.renderer();if(!e)throw new Error("Cannot render figure, renderer is not available.");return this.wrapper=e.path(this.get("path")),this.wrapper.attr(this.attributes),this.wrapper.control=this,this.bindEvents(),this},bounds:function(){if(this.wrapper)return this.wrapper.getABox()}},{defaults:_.extend({},p.defaults,{path:""})}),b=t.Text=t.Figure.extend({constructor:function(e){e||(e={});var n=e.figure||e;t.Figure.apply(this,[e]),this.defaults=_.extend({},b.defaults,b.textDefaults),this.attributes=_.extend({},b.defaults,_.object(_.filter(_.pairs(n),this.filterAttributes))),this.textAttributes=_.extend({},b.textDefaults,_.object(_.filter(_.pairs(n),this.filterTextAttributes))),this.position=b.getPosition(this,n),this.initialize(e)},filterAttributes:function(e){return _.has(b.defaults,e[0])},filterTextAttributes:function(e){return _.has(b.textDefaults,e[0])},get:function(e){return this.textAttributes[e]?this.textAttributes[e]:this.attributes[e]},setValue:function(e,t){_.has(this.textAttributes,e)?(this.textAttributes[e]=t,this.text&&this.text.attr(e,t)):(this.attributes[e]=t,this.wrapper&&(_.contains(["width","height","x","y"],e)&&this.layoutText(),this.wrapper.attr(e,t)))},layoutText:function(){if(!this.text)return;this.resizeBox();var e=this.bounds(),t=this.text,n=t.getABox();t.attr("y",e.yMiddle),this.position==="center"&&t.attr("x",e.xCenter),this.position==="left"&&t.attr("x",e.x+n.width/2),this.position==="right"&&t.attr("x",e.xRight-n.width/2)},setPosition:function(){if(this.text){this.wrapper.attr({x:this.get("x"),y:this.get("y")});var e=this.text.getBBox(),t=this.get("x")+e.width/2,n=this.get("y")+e.height/2;this.text.attr({x:t,y:n})}},render:function(){this.remove();var e=this.renderer();return this.wrapper=e.rect(),this.text=e.text(0,0,this.textAttributes.text),this.text.attr(this.textAttributes),this.set({x:this.get("x"),y:this.get("y")}),this.wrapper.attr(this.attributes).attr({stroke:"none",fill:"white","fill-opacity":0}),this.layoutText(),this.toFront(),this.wrapper.control=this,this.bindEvents(),this},resizeBox:function(){var e=this.text.getBBox(),t=this.get("width"),n=this.get("height");t<e.width&&this.set("width",e.width),n<e.height&&this.set("height",e.height)},remove:function(){return this.wrapper&&(this.wrapper.remove(),this.text.remove(),this.unBindEvents(this.text),delete this.wrapper,delete this.text),this},minimumSize:function(){var e=this.text.getBBox();return{width:e.width,height:e.height}},toFront:function(){if(!this.wrapper)return;this.text.toFront(),this.wrapper.toFront()},toBack:function(){if(!this.wrapper)return;this.text.toBack(),this.wrapper.toBack()}},{textDefaults:{"font-size":12,text:"Label","font-weight":"normal","font-style":"normal","font-family":"Arial",fill:"black","fill-opacity":1,stroke:"none","stroke-opacity":1,"stroke-width":1},defaults:{width:0,height:0,x:0,y:0},positions:["center","left","right"],getPosition:function(e,t){var n=e.position||"center";return t&&t.position&&_.include(b.positions,t.position)&&(n=t.position),n}}),w=t.DiagramElement=t.Element.extend({constructor:function(e){e||(e={}),t.Element.apply(this,[e]),this.parent=e.parent||undefined,this.diagram=this.parent?this.parent.diagram:e.diagram,this.set("id",e.id||_.uniqueId()),this.setFigure(e.figure||this.figure),this.set(e)},setFigure:function(e){e instanceof p?this.figure=e:this.figure=p.create(this,e)},render:function(){return this},remove:function(){return this.figure&&this.figure.remove(),this},paper:function(){!this.diagram&&this.parent&&(this.diagram=this.parent.diagram);if(!this.diagram)throw new Error("Element must be associated to a diagram");return this.diagram.paper()},get:function(e){return this.figure&&_.has(this.figure.defaults,e)?this.figure.get(e):u.prototype.get.apply(this,arguments)},set:function(e,t){var n;_.isObject(e)?n=e:(n={})[e]=t;for(var r in n)this.figure&&_.has(this.figure.defaults||{},r)?this.figure.set(r,n[r]):this.attributes[r]=n[r];return this},setParent:function(e){return this.parent=e,this.diagram||(this.diagram=e.diagram),this},show:function(){return this.figure&&this.figure.show(),this},hide:function(){return this.figure&&this.figure.hide(),this},toFront:function(){return this.figure&&this.figure.toFront(),_.each(this.children,function(e){e.toFront()}),this},toBack:function(){return _.each(this.children,function(e){e.toBack()}),this.figure&&this.figure.toBack(),this},isPointInside:function(e){return this.figure?this.figure.isPointInside(e):!1},getByPoint:function(e){var t=[];return this.isPointInside(e)&&(t.push(this),t.push(_.map(this.children,function(t){return t.getByPoint(e)}))),t}}),N=function(e,t){this.shape=e,this.type=t.type};N.extend=a,N.layouts=function(){return{xy:H,flow:P,grid:O,border:B}},N.create=function(e,t){var n=e.layout||t.layout,r=n?n.type:null,i,s;return _.has(N.layouts(),r)&&(s=N.layouts()[r],i=new s(e,n)),i},N.prototype={layout:function(){},minimumSize:function(){},maximumSize:function(){},preferredSize:function(){}};var C=t.LayoutElement=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),e.gridData&&(this.gridData=e.gridData),this.initialize(e)},bounds:function(){return this.figure?this.figure.bounds():{x:this.get("x"),y:this.get("y"),width:this.get("width"),height:this.get("height")}},preferredSize:function(){return this.layout?this.layout.preferredSize():this.figure.preferredSize()},minimumSize:function(){return this.layout?this.layout.minimumSize():this.figure.minimumSize()},maximumSize:function(){return this.layout?this.layout.maximumSize():this.figure.maximumSize()},doLayout:function(){if(!this.layout)return;this.layout.layout(),this.renderEdges()}});t.Diagram=t.Element.extend({constructor:function(e){e||(e={}),t.Element.apply(this,[e]),this._selection=null,this._currentSource=null,this._currentEdge=null,this.isSelecting=!1,this.isDragging=!1,this._handlers=[],this.set("edges",[]),e.el&&(this.el=e.el),this.el&&this.setElement(this.el),this.initialize(e)},paper:function(){return this._paper||this._initPaper(),this._paper},setElement:function(e){if(!e)return this;if(_.isString(e)){var t=e.indexOf("#")===0?e.slice(1,e.length):e;this.el=document.getElementById(t)}else e instanceof HTMLElement&&(this.el=e);return this},canvas:function(){return this._paper?this._paper.canvas:null},render:function(){var e=this.paper(),t=e.canvas,n=t.clientLeft,r=t.clientTop,i=t.width.baseVal.value,s=t.height.baseVal.value;return this.wrapper&&this.wrapper.remove(),this.wrapper=this.paper().rect(n,r,i,s,0).attr({fill:"white",opacity:0,stroke:"none"}),this.bindEvents(),_.each(this.get("children"),function(e){e.render()}),_.each(this.get("edges"),function(e){e.render()}),this.on("mousedown touchstart",this.changeViewBox),this.on("mousedown touchstart",this.selectGroup),this.on("click",this.deselect,this),this},_events:["click","dblclick","mouseout","mouseup","mouseover","mousedown","mousemove","touchstart","touchmove","touchend","touchcancel"],bindEvents:function(){var e=this,t=this.wrapper,n=function(t){return{eve:t,handler:function(n){e.trigger(t,n)}}},r=function(e){t[e.eve](e.handler)};this._handlers=_.map(this._events,n),_.each(this._handlers,r)},unBindEvents:function(){var e=this.wrapper,t=function(t){e["un"+t.eve](t.handler)};_.each(this._handlers,t),this._handlers.length=0},setViewBox:function(e,t,n,r){var i=e||0,s=t||0,o=n||this._paper.width,u=r||this._paper.height;this._paper&&this._paper.setViewBox&&this._paper.setViewBox(i,s,o,u)},zoom:function(e){var t=this.wrapper.attr("x"),n=this.wrapper.attr("y"),r=this.paper(),i=this._paper.width=r.width+e,s=this._paper.height=r.height+e;this.setViewBox(t,n,i+e,s+e)},remove:function(){this._paper&&(_.each(this.get("children"),function(e){e.remove()}),_.each(this.get("edges"),function(e){e.remove()}),this._paper.remove(),this._paper=null)},changeViewBox:function(e){if(!this.isDragging)return;var t=r.get(this,e),n;this.wrapper.toFront();var i=function(e){var i=new r(this.wrapper.attr("x"),this.wrapper.attr("y"));e.stopImmediatePropagation(),n=r.get(this,e),i.sub(t.vector(n)),this.wrapper.attr(i),this.setViewBox(i.x,i.y),t=n},s=function(e){e.stopImmediatePropagation(),this.wrapper.toBack(),this.off("mouseup touchend touchcancel",s),this.off("mousemove touchmove",i)};this.on("mouseup touchend touchcancel",s),this.on("mousemove touchmove",i)},selectGroup:function(e){if(!this.isSelecting)return;var t=r.get(this,e),n=this.paper().rect(t.x,t.y,0,0),i,s,o,u,a,f,l,c;n.attr({"fill-opacity":.15,"stroke-opacity":.5,fill:"#007fff",stroke:"#007fff"}),this.wrapper.toFront();var h=function(e){e.stopImmediatePropagation(),i=r.get(this,e),s=n.getABox(),o=i.x-t.x,u=i.y-t.y,a=n.attr("width"),l=n.attr("height"),f=a+o,c=l+u,s.x<=i.x?s.xRight>i.x&&o>0&&(n.attr("x",i.x),f=a-o):(n.attr("x",i.x),f=a-o);if(s.y>i.y||u>0&&s.yBottom>i.y)n.attr("y",i.y),c=l-u;f>=0&&c>=0&&n.attr({width:f,height:c}),t=i},p=function(e){e.stopImmediatePropagation(),this.wrapper.toBack(),this.isSelecting=!1,this.off("mouseup touchend touchcancel",p),this.off("mousemove touchmove",h),n.remove()};this.on("mouseup touchend touchcancel",p),this.on("mousemove touchmove",h)},createShape:function(e,t){var n=null,r=t||{};if(!e)throw new Error("Cannot create Shape if Shape constructor is missing.");return r.diagram=this,n=new e(r),n},removeShape:function(e){if(!e)return;var t=this.get("children");this.set("children",_.reject(t,function(t){return t===e})),this.trigger("remove:children",e)},getShape:function(e){if(!e)return null;var t=_.find(this.get("children"),function(t){return t.get("id")===e});return t},getShapesByPoint:function(e){var t=arguments;if(!e)return null;t.length===2&&(e={x:t[0],y:t[1]});if(isNaN(e.x)||isNaN(e.y))return[];var n=function(t){return t.getByPoint(e)};return _.flatten(_.map(this.get("children"),n))},getShapesByBox:function(e){if(!e||!e.x)return[];var t,n=function(n){return t=n.bounds(),e.x<=t.x&&e.xRight>=t.x&&e.y<=t.y&&e.yBottom>=t.y};return _.filter(this.get("children"),n)},createConnection:function(e,t){if(typeof e!="function")return;var n=null,r=t||{},i=r.source,s=r.target;return r.diagram=this,n=new e(r),i&&s&&n.connect(i,s),n.on("remove:source remove:target",function(e){this.removeConnection(e)},this),n},removeConnection:function(e){if(!e)return;var t=this.get("edges");this.set("edges",_.reject(t,function(t){return t===e})),this.trigger("remove:edges",e)},getConnection:function(e){if(!e)return null;var t=_.find(this.get("edges"),function(t){var n=t.get("id");if(n)return n===e});return t},canConnect:function(e){return this.currentEdge?this.currentSource?!0:(this.currentSource=e,!1):!1},connect:function(e){var t=null;return this.currentEdge&&this.currentSource&&(t=this.createConnection(this.currentEdge,{source:this.currentSource,target:e}),this.currentEdge=null,this.currentSource=null),t},deselect:function(){this._selection&&typeof this._selection.deselect=="function"&&(this._selection.deselect(),delete this._selection)},setSelection:function(e){this._selection&&this._selection.deselect(),this._selection=e,this.trigger("select",e)},getSelection:function(){return this._selection},parse:function(e){},toJSON:function(){},_initPaper:function(){if(!this.el)throw new Error("Cannot initialize Raphael Object, Diagram Element is missing, use setElement() before.");if(this._paper)return;this._paper=Raphael(this.el,this.width,this.height),this.setViewBox(0,0,this._paper.width,this._paper.height)},_canCreate:function(e){var t=_.find(this.children,function(t){return t===e});return t!==undefined}});var k=t.ToolBox=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.element=e.element,this.width=70,this.height=60},render:function(){if(!this.element&&!this.element.wrapper)return;this.wrapper&&this.wrapper.remove();var e=this.element.paper(),t=this.element.wrapper.getABox(),n=t.xRight-40,r=t.y-30;this.wrapper=e.rect(n,r,this.width,this.height,6).attr({fill:"orange","fill-opacity":0,stroke:"black","stroke-opacity":0,"stroke-width":2}).toBack(),this.wrapper.controller=this,this.wrapper.mouseover(this.handleMouseOver),this.wrapper.mouseout(this.handleMouseOut),t=this.wrapper.getABox();var i=this;return this.addItem(t.xLeft+20,t.y,L,function(e){i.element.remove(!0)}),this},addItem:function(e,t,n,r){var i=this,s=this.element.paper(),o=s.path(n);return o.attr({fill:"#000",stroke:"none"}),o.attr({cursor:"pointer"}),o.translate(e,t),o.scale(.8,.8),this.get("children").push(o),o.mouseover(function(e){i.isOverChild=!0}),o.mouseout(function(e){e.stopPropagation(),i.isOverChild=!1}),o.click(r),this},remove:function(){this.wrapper&&(this.wrapper.remove(),_.each(this.get("children"),function(e){e.remove()}),this.get("children").length=0)},handleMouseOver:function(){this.controller.isOver=!0},handleMouseOut:function(e){e.stopPropagation()}}),L="M20.826,5.75l0.396,1.188c1.54,0.575,2.589,1.44,2.589,2.626c0,2.405-4.308,3.498-8.312,3.498c-4.003,0-8.311-1.093-8.311-3.498c0-1.272,1.21-2.174,2.938-2.746l0.388-1.165c-2.443,0.648-4.327,1.876-4.327,3.91v2.264c0,1.224,0.685,2.155,1.759,2.845l0.396,9.265c0,1.381,3.274,2.5,7.312,2.5c4.038,0,7.313-1.119,7.313-2.5l0.405-9.493c0.885-0.664,1.438-1.521,1.438-2.617V9.562C24.812,7.625,23.101,6.42,20.826,5.75zM11.093,24.127c-0.476-0.286-1.022-0.846-1.166-1.237c-1.007-2.76-0.73-4.921-0.529-7.509c0.747,0.28,1.58,0.491,2.45,0.642c-0.216,2.658-0.43,4.923,0.003,7.828C11.916,24.278,11.567,24.411,11.093,24.127zM17.219,24.329c-0.019,0.445-0.691,0.856-1.517,0.856c-0.828,0-1.498-0.413-1.517-0.858c-0.126-2.996-0.032-5.322,0.068-8.039c0.418,0.022,0.835,0.037,1.246,0.037c0.543,0,1.097-0.02,1.651-0.059C17.251,18.994,17.346,21.325,17.219,24.329zM21.476,22.892c-0.143,0.392-0.69,0.95-1.165,1.235c-0.474,0.284-0.817,0.151-0.754-0.276c0.437-2.93,0.214-5.209-0.005-7.897c0.881-0.174,1.708-0.417,2.44-0.731C22.194,17.883,22.503,20.076,21.476,22.892zM11.338,9.512c0.525,0.173,1.092-0.109,1.268-0.633h-0.002l0.771-2.316h4.56l0.771,2.316c0.14,0.419,0.53,0.685,0.949,0.685c0.104,0,0.211-0.017,0.316-0.052c0.524-0.175,0.808-0.742,0.633-1.265l-1.002-3.001c-0.136-0.407-0.518-0.683-0.945-0.683h-6.002c-0.428,0-0.812,0.275-0.948,0.683l-1,2.999C10.532,8.77,10.815,9.337,11.338,9.512z",A="M26.834,14.693c1.816-2.088,2.181-4.938,1.193-7.334l-3.646,4.252l-3.594-0.699L19.596,7.45l3.637-4.242c-2.502-0.63-5.258,0.13-7.066,2.21c-1.907,2.193-2.219,5.229-1.039,7.693L5.624,24.04c-1.011,1.162-0.888,2.924,0.274,3.935c1.162,1.01,2.924,0.888,3.935-0.274l9.493-10.918C21.939,17.625,24.918,16.896,26.834,14.693z",O=N.extend({constructor:function(e,t){t||(t={}),N.apply(this,[e,t]),this.columns=t.columns||1,this.rows=t.rows||0,this.marginHeight=t.marginHeight||0,this.marginWidth=t.marginWidth||0,this.vgap=t.vgap||0,this.hgap=t.hgap||0,this.columnsEqualWidth=t.columnsEqualWidth||!1},getRows:function(){var e=this.shape.children,t=this.columns||e.length;return this.rows>0?this.rows:Math.floor((e.length+t-1)/t)},getColumns:function(){var e=this.shape.children;return this.rows>0?Math.floor((e.length+this.rows-1)/this.rows):this.columns},layout:function(){if(!this.shape.children||!this.shape.children.length)return;_.each(this.computeRows("preferred"),function(e){_.each(e.cells,function(e){e.layout()})},this)},computeRows:function(e){var t=this.shape.bounds(),n=this.getColumns(),r=this.shape.children,i=[],s={width:0,height:0,cells:[]},o;i.push(s);for(var u=0,a=1;u<r.length;u++,a++){var f=r[u],l=new M({shape:f,grid:this});l.size=r[u][e+"Size"](),o&&(l.previous=o,o.next=l),o=l;if(!f.gridData||!(f.gridData instanceof D))f.gridData=new D(f.gridData),f.gridData.grid=l.grid;s.cells.push(l);if(a>=n){if(u!=r.length-1){var c={previous:s,width:0,height:0,cells:[]};s.next=c,s=c,i.push(s)}a=0}}var h=this.marginWidth,p=this.marginHeight,d=function(){var e=[];for(var t=0;t<n;t++){e.push([]);for(var r=0;r<i.length;r++){var s=i[r].cells[t];s&&e[t].push(s)}}return e},v=function(e){var n=_.reduce(e,function(e,t){return t.shape.gridData.grabExcessVerticalSpace?e:e+t.size.height},0),r=_.reduce(e,function(e,t){return t.shape.gridData.grabExcessVerticalSpace?e+1:e},0);return(t.height-p*2-n)/r},m=function(e){var n=_.reduce(e.cells,function(e,t){return t.shape.gridData.grabExcessHorizontalSpace?e:e+t.size.width},0),r=_.reduce(e.cells,function(e,t){return t.shape.gridData.grabExcessHorizontalSpace?e+1:e},0),i=(t.width-h*2-n)/r;return i},g=t.x+this.marginWidth,y=t.y+this.marginHeight,b=g,w;return _.each(d(),function(e){var t=v(e);_.each(e,function(e){e.shape.gridData.grabExcessVerticalSpace?e.height=t:e.height=e.size.height},this)},this),_.each(i,function(e){var r=m(e);_.each(e.cells,function(i){i.x=b,i.y=y,this.columnsEqualWidth?i.width=t.width/n:i.shape.gridData.grabExcessHorizontalSpace?i.width=r:i.width=i.size.width,e.width+=i.width,b+=i.width+this.hgap},this);var i=null;e.cells.length&&(i=_.max(e.cells,function(e){return e.height})),e.height=i?i.height:0,y+=e.height+this.vgap,b=g},this),i},size:function(e){var t=0,n=0,r=this.shape.children,i=this.getColumns(),s=this.getRows(),o=this.shape.bounds(),u,a=this.computeRows(e),f=_.max(a,function(e){return e.width});t=f?f.width:0,n=_.reduce(a,function(e,t){return e+t.height},0),t=t+(i-1)*this.hgap+this.marginWidth*2,n=n+(s-1)*this.vgap+this.marginHeight*2;var l=this.shape.figure.minimumSize();return t=Math.max(l.width,t),n=Math.max(l.height,n),o.width>t&&(t=o.width),o.height>n&&(n=o.height),{width:t,height:n}},preferredSize:function(){return this.size("preferred")},minimumSize:function(){return this.size("minimum")},maximumSize:function(){return this.size("maximum")}}),M=function(e){e||(e={}),this.shape=e.shape,this.grid=e.grid,this.x=e.x,this.y=e.y,this.grid.columnsEqualWidth?this.width=this.grid.columnWidth:this.width=this.shape.get("width"),this.height=this.shape.get("height")};M.prototype.layout=function(){this.shape.set(this.align()),this.shape.doLayout()},M.prototype.align=function(){var e=this.shape.gridData,t=e.horizontalAlignment,n=e.verticalAlignment,r=this.x,i=this.y,s=this.shape.get("width"),o=this.shape.get("height");return t==="fill"&&(s=this.width),n==="fill"&&(o=this.height),t==="center"&&(r=r+this.width/2-s/2),n==="center"&&(i=i+this.height/2-o/2),t==="end"&&(r=r+this.width-s),n==="end"&&(i=i+this.height-o),{x:r,y:i,width:s,height:o}};var D=t.GridData=function(e){e||(e={}),this.grid=e.grid,this.verticalAlignment=D.getVerticalAlignment(e),this.horizontalAlignment=D.getHorizontalAlignment(e),this.grabExcessVerticalSpace=e.grabExcessVerticalSpace||!1,this.grabExcessHorizontalSpace=e.grabExcessHorizontalSpace||!1,this.verticalSpan=e.verticalSpan||1,this.horizontalSpan=e.horizontalSpan||1};D.alignments=["center","fill","beginning","end"],D.getAlignment=function(e,t){var n=e[t+"Alignment"];return _.contains(D.alignments,n)?n:null},D.getVerticalAlignment=function(e){return D.getAlignment(e,"vertical")||"center"},D.getHorizontalAlignment=function(e){return D.getAlignment(e,"horizontal")||"beginning"};var P=N.extend({constructor:function(e,t){t||(t={}),N.apply(this,[e,t]),this.vertical=t.vertical},layout:function(){var e={x:this.shape.get("x"),y:this.shape.get("y")},t=this.shape.bounds(),n=this.shape.children,r,i=[],s={width:0,height:0},o=function(e,t,n,r){var i={x:t.x,y:t.y},o=0,u=e.length;i.x+=(r.width-s.width)/2;for(;o<u;o++)i.y=t.y,e[o].set(i),e[o].doLayout(),i.x+=e[o].bounds().width};_.each(n,function(n){r=n.preferredSize(),s.width+r.width>t.width&&(o(i,s,t),i=[],e.y+=r.height,s.width=0,s.height=0),s.height=Math.max(s.height,r.height),s.width+=r.width,n.set(r),i.push(n)}),o(i,e,r,t)},size:function(){var e=this.shape.bounds(),t=this.shape.children,n=0,r=0,i=0,s=!1,o,u="preferred";if(!t||!t.length)return{width:e.width,height:e.height};for(;n<t.length;n++)o=t[n][u+"Size"](),i=Math.max(i,o.height),r+=o.width;return r<e.width&&(r=e.width),i<e.height&&(i=e.height),{width:r,height:i}}}),H=N.extend({constructor:function(e,t){t||(t={}),N.apply(this,[e,t])},layout:function(){var e=this.shape,t=e.bounds(),n=e.children,r=n.length,i=0,s;for(;i<r;i++)s=n[i],s.figure.translate(t.x,t.y),s.doLayout()},minimumSize:function(){return this.shape.figure.bounds()},preferredSize:function(){return this.shape.figure.bounds()},maximumSize:function(){return this.shape.figure.bounds()}}),B=N.extend({constructor:function(e,t){t||(t={}),N.apply(this,[e,t]),this.vgap=t.vgap||0,this.hgap=t.hgap||0},layout:function(){var e=this.shape.bounds(),t=e.y,n=e.bottomLeft.y,r=e.xLeft,i=e.xRight,s;this.north&&(s=this.north.preferredSize(),this.north.set({x:r,y:t,width:i-r,height:s.height}),this.north.doLayout(),t+=s.height+this.vgap),this.south&&(s=this.south.preferredSize(),this.south.set({x:r,y:n-s.height,width:i-r,height:s.height}),this.south.doLayout(),n-=s.height+this.vgap),this.east&&(s=this.east.preferredSize(),this.east.set({x:i-s.width,y:t,width:s.width,height:n-t}),this.east.doLayout(),i-=s.width+this.hgap),this.west&&(s=this.west.preferredSize(),this.west.set({x:r,y:t,width:s.width,height:n-t}),this.west.doLayout(),r+=s.width+this.hgap),this.center&&(this.center.set({x:r,y:t,width:i-r,height:n-t}),this.center.doLayout())},size:function(){return this.shape.bounds()}});t.BoundBox=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.control=e.control,this.control.on("start:move",this.stateMove,this),this.control.on("start:resize",this.stateSize,this),this.control.on("end:move end:resize",this.stateNone,this)},stateMove:function(){this.state="move",this._left="x",this._right="y"},stateSize:function(){this.state="resize",this._left="width",this._right="height"},stateNone:function(){delete this.state},render:function(){this.remove();var e=this.control.paper(),t=this.control.bounds(),n=t.xRight+15,r=t.yMiddle;this.text=e.text(n,r,this.getText());var i=this.text.getABox().width;return this.text.translate(i/2+10,10),this.shadow=e.rect(n,r,i+20,20),this.shadow.attr({fill:"black",opacity:.2,stroke:"none"}),this.shadow.translate(2,2),this.wrapper=e.rect(n,r,i+20,20),this.wrapper.attr({fill:"#FFFF99",opacity:1,stroke:"none"}),this.text.toFront(),this},remove:function(){if(!this.wrapper)return;this.wrapper.remove(),this.shadow.remove(),this.text.remove()},getText:function(){return this.getTemplate()({left:this.control.get(this._left),right:this.control.get(this._right)})},getTemplate:function(){return this.state==="move"?_.template("x: <%= left %>px y: <%= right %>px"):this.state==="resize"?_.template("width: <%= left %>px  height: <%= right %>px"):null}}),t.Selectable={anchors:["NorthAnchor","NorthEastAnchor","NorthWestAnchor","SouthAnchor","SouthEastAnchor","SouthWestAnchor","EastAnchor","WestAnchor"],createAnchor:function(e){return(new t[e]({box:this})).render()},createSelectionBox:function(){var e=this.figure.bounds(),t=e.x,n=e.y,r=e.width,i=e.height;this.selectionBox=this.paper().rect(t,n,r,i,0),this.selectionBox.attr(this.selectionStyle),this.selectionBox.toFront()},select:function(){if(!this.figure)return;this.diagram.setSelection(this),this.createSelectionBox(),this.selectionAnchors=_.map(this.anchors,this.createAnchor,this)},deselect:function(){this._tool&&this._tool.remove(),this.selectionAnchors&&_.each(this.selectionAnchors,function(e){e.remove()}),this.selectionBox&&this.selectionBox.remove()}};var j=t.Anchor=t.DiagramElement.extend({cursor:"none",constructor:function(e){t.DiagramElement.apply(this,[e]),this.box=e.box,this.diagram=this.box.diagram,this.initialize.apply(this,arguments)},initialize:function(e){},render:function(){var e=this.paper();return this.wrapper=e.rect(this.x,this.y,6,6,0).attr(this.box.anchorStyle),this.box.resizable&&this.wrapper.attr({cursor:this.cursor}),this.wrapper.box=this.box,this.wrapper.anchor=this,this.box.resizable&&this.wrapper.drag(j.move,j.start,j.end),this},hide:function(){this.wrapper&&this.wrapper.hide()},remove:function(){this.wrapper&&this.wrapper.remove();if(this.box){var e=this.box;this.box=null,e.anchor&&delete e.anchor}}});j.start=function(){var e=this.anchor,t=this.box;e.active=!0,this.o(),this.box.figure.wrapper.o(),t.startResize()},j.move=function(e,t,n,r,i){var s=this.box,o=this.anchor.direction;this.attr({x:this.ox+e,y:this.oy+t}),s.resize(e,t,o)},j.end=function(){var e=this.anchor,t=this.box;e.active=!1,t.endResize(),e.box.select()},t.NorthWestAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.x-3,this.y=t.y-3,this.cursor="nw-resize",this.direction="nw"}}),t.SouthWestAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xLeft-3,this.y=t.yBottom-3,this.cursor="sw-resize",this.direction="sw"}}),t.NorthEastAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xRight-3,this.y=t.y-3,this.cursor="ne-resize",this.direction="ne"}}),t.SouthEastAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xRight-3,this.y=t.yBottom-3,this.cursor="se-resize",this.direction="se"}}),t.NorthAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xCenter-3,this.y=t.y-3,this.cursor="n-resize",this.direction="n"}}),t.SouthAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xCenter-3,this.y=t.yBottom-3,this.cursor="s-resize",this.direction="s"}}),t.WestAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.x-3,this.y=t.yMiddle-3,this.cursor="w-resize",this.direction="w"}}),t.EastAnchor=j.extend({initialize:function(e){var t=e.box.figure.bounds();this.x=t.xRight-3,this.y=t.yMiddle-3,this.cursor="e-resize",this.direction="e"}});var F=t.Image=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e])},render:function(){var e=this.paper(),t=this.parent.wrapper.getBBox(),n=this.get("src"),r=this.get("width"),i=this.get("height");return this.wrapper=e.image(n,t.x,t.y,r,i),this.wrapper.toFront(),this.wrapper.controller=this,this},center:function(){var e=this.parent.wrapper.getABox();this.wrapper.attr({x:e.x-this.get("width")}),this.wrapper.attr({y:e.yMiddle-this.get("height")/2})}}),I=t.Label=t.LayoutElement.extend({resizable:!1,editable:!0,draggable:!0,constructor:function(e){e||(e={}),t.LayoutElement.apply(this,[e]),this.initProperties(e);var n=this.figure?this.figure.image:e.figure.image;n&&this.setImage(n),this.initialize(e)},initProperties:function(e){var t=["resizable","editable","draggable"],n=function(t){_.isBoolean(e[t])&&(this[t]=e[t])};_.each(t,n,this)},setImage:function(e){e.parent=this;var n=new t.Image(e);return this.image=n,n},render:function(){return this.figure.render(),this.figure.toFront(),this.image&&this.image.render(),this.editable&&this.asEditable(),this.draggable&&this.figure.asDraggable(),this},setText:function(e,t){this.set("text",e),this.doLayout(),t||this.trigger("change:text",this)},getText:function(){return this.get("text")},remove:function(){this.image&&this.image.remove(),this.figure&&this.figure.remove()},removeContent:function(){},renderEdges:function(){},renderContent:function(){},doLayout:function(){this.figure&&this.figure.layoutText()},toFront:function(){this.figure&&this.figure.toFront(),this.image&&this.image.toFront()},preferredSize:function(){return{width:this.get("width"),height:this.get("height")}},minimumSize:function(){return this.figure.minimumSize()},asEditable:function(){var e=this,t=e.diagram,n=function(e){var t=e.bounds(),n=e.diagram.el.offsetLeft,r=e.diagram.el.offsetTop,i=t.x+(isNaN(n)?0:n),s=t.y+(isNaN(r)?0:r),o=t.width,u=t.height,a="form-input-"+e.get("id"),f=document.getElementById(a);f&&f.parentNode.removeChild(f),f=document.createElement("form");var l=document.createElement("input");return f.setAttribute("id",a),f.setAttribute("style","position: absolute; left: "+i+"px; top: "+s+"px;"),l.setAttribute("type","text"),l.value=e.getText()||"",l.setAttribute("style","width:"+o+"px; height: "+u+"px;"),f.appendChild(l),{form:f,input:l}},r=function(t){t.stopImmediatePropagation();if(!e.el)return;var n=e.el.input.value;e.setText(n),e.el.form.removeEventListener("blur",r,!0),e.el.form.parentNode.removeChild(e.el.form),delete e.el,delete e.domNode};e.on("dblclick",function(t){t.stopImmediatePropagation();var i=n(e);e.el=i,e.domNode=e.diagram.el.parentNode,e.domNode.appendChild(i.form),e.el.form.focus(),e.el.form.addEventListener("blur",r,!0)})}});_.extend(t.Label.prototype,t.Selectable,t.Resizable,t.Events);var q=t.Shape=t.LayoutElement.extend({connectable:!0,showShadow:!1,resizable:!0,draggable:!0,showToolBox:!0,showBoundBox:!0,constructor:function(e){e||(e={}),t.DiagramElement.apply(this,[e]),this.ins=[],this.outs=[],_.isBoolean(e.draggable)&&(this.draggable=e.draggable),_.isBoolean(e.resizable)&&(this.resizable=e.resizable),_.isBoolean(e.showToolBox)&&(this.showToolBox=e.showToolBox),_.isBoolean(e.showBoundBox)&&(this.showBoundBox=e.showBoundBox),e.children&&(this.children=e.children),this.setUpChildren(),this.setUpLayout(e),this.setUpStyles(e),this.setUpToolBox(),this.setUpBoundBox(),this.initialize.apply(this,arguments),this.diagram&&!this.parent&&(this.diagram.get("children").push(this),this.diagram.trigger("add:children",this))},setUpToolBox:function(e){this.showToolBox&&(this.toolBox=new k({element:this}))},setUpBoundBox:function(){this.showBoundBox&&(this.boundBox=new t.BoundBox({control:this}))},setUpStyles:function(e){_.each(_.keys(t.Styles),function(n){e[n]?this[n]=_.clone(e[n]):this[n]=_.clone(t.Styles[n])},this)},render:function(){return this.layout&&this.set(this.layout.preferredSize()),this.figure.render(),this.renderContent(),this.on("click",this.select),this.on("click",this.showTool),this.on("mousedown",this.handleClick),this.on("mouseout",this.removeToolWhenOut),this.draggable&&this.asDraggable(),this},dragConnection:function(e,t){e&&e.stopPropagation();if(!t||typeof t!="function")return;var n=this;n.connecting=!0;var r=new t({diagram:n.diagram});r.connectByDragging(n,e),r.render();var i=function(){n.connecting=!1,r.off("connect",i)};r.on("connect",i)},showTool:function(){this._tool&&this._tool.render()},removeToolWhenOut:function(){var e=this;e.toolBox&&window.setTimeout(function(){e.toolBox&&!e.toolBox.isOver&&e.toolBox.remove()},1e3)},remove:function(e){this.deselect(),this.figure.remove(),_.each(this.children,function(e){e.remove()}),_.each(this.ins,function(t){t.remove(e)}),_.each(this.outs,function(t){t.remove(e)}),this.shadow&&(this.shadowWrapper.remove(),delete this.shadowWrapper),this.selectionBox&&this.selectionBox.remove(),this.toolBox&&(this.toolBox.remove(),delete this.toolBox),e&&this.diagram.removeShape(this)},disconnect:function(e,t){return e?(!t||t!=="in"&&t!=="out"?(this.ins=_.without(this.ins,e),this.outs=_.without(this.outs,e)):this[t+"s"]=_.without(this[t+"s"],e),this):this},canAdd:function(e){if(typeof e!="function")return!1;if(!this.accepts)return!1;var t=new e({});return _.some(this.accepts,function(e){return t instanceof e})},canConnect:function(e){return!0},add:function(e){return e.setParent(this),this.children.push(e),this.trigger("add:children",e),this},toJSON:function(){return _.clone(this.attributes)},setUpLayout:function(e){this.layout=N.create(this,e)},setUpChildren:function(){var e=this.children,n;this.children=[],_.each(e,function(e){S(e)?n=new I(e):E(e)?n=new t.Image(e):typeof e=="function"?n=new e({parent:this}):typeof e=="object"&&(n=new q(e)),n&&this.add(n)},this)},removeContent:function(){_(this.children).each(function(e){e.remove()})},renderContent:function(){_(this.children).each(function(e){e.render()}),this.parent||this.doLayout()},renderEdges:function(){_(this.ins).each(function(e){e.render()}),_(this.outs).each(function(e){e.render()})},asDraggable:function(){return this.figure&&this.figure.asDraggable(),this}});t.Resizable={startResize:function(){this.toolBox&&this.toolBox.remove(),this.shadow&&this.shadowWrapper.remove(),_.each(this.selectionAnchors,function(e){e.active?e.hide():e.remove()}),this.removeContent(),this.figure&&this.figure.startResize(this.resizeStyle),this.trigger("start:resize")},resize:function(e,t,n){return this.resizable?(this.figure&&this.figure.resize(e,t,n),this.boundBox&&this.boundBox.render(),this.renderEdges(),this):this},endResize:function(){this.figure&&this.figure.endResize(),this.renderContent(),this.shadow&&this.createShadow(),this.boundBox&&this.boundBox.remove(),this.trigger("end:resize")}},_.extend(t.Shape.prototype,t.Selectable,t.Resizable,t.Events),t.arrows={none:function(e){return e||(e=2),{path:"M"+e+",0L"+ -e+",0",dx:e,dy:e,attr:{opacity:0}}},basic:function(e,t){return t||(t=4),{path:["M",t.toString(),"0","L",(-t).toString(),(-t).toString(),"L",(-t).toString(),t.toString(),"z"],dx:t,dy:t,attr:{stroke:"black",fill:"black"}}}};var R=t.ConnectionAnchor=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]),this.connection=e.connection,this.diagram=this.connection.diagram},bounds:function(){return this.wrapper?this.wrapper.getABox():null},position:function(){return this.connection.get("sourceAnchor")===this?"source":"end"},move:function(e){return this.x=e.x,this.y=e.y,this.wrapper&&this.wrapper.attr({x:this.x-2,y:this.y-2}),this},render:function(){if(this.wrapper)return this;var e=this.paper();return this.wrapper=e.rect(this.x-3,this.y-3,6,6),this.wrapper.attr({fill:"black",stroke:"none"}),this.wrapper.anchor=this,this.asDraggable(),this},remove:function(){this.wrapper&&this.wrapper.remove()},getConnectableElement:function(){var e=this,t=this.wrapper,n=this.connection,r=this.diagram.getShapesByPoint(this.x,this.y),i=function(t,r){return n.canConnect(r,e.position())&&t.push(r),t},s=_.reduceRight(r,i,[]);return s.length?s[0]:null},establishConnection:function(e){var t=this,n=this.wrapper,r;e&&(t.shape=e),t.connection.state=null,this.position()==="end"?t.connection.connect(t.connection.get("sourceAnchor").shape,t.shape):t.connection.connect(t.shape,t.connection.get("targetAnchor").shape),t.connection.render()},asDraggable:function(){var e=function(e,t){this.attr({x:this.ox+e,y:this.oy+t}),this.anchor.connection.state="dragging",this.anchor.connection.dragger=this.anchor,this.anchor.connection.render()},t=function(){this.o(),this.anchor.shape.disconnect(this.anchor.connection)},n=function(){var e=this.anchor.getConnectableElement();e&&this.anchor.establishConnection(e)};return this.wrapper.drag(e,t,n),this},attach:function(e){var t=e.bounds();return t.xCenter&&t.yMiddle&&(this.x=t.xCenter,this.y=t.yMiddle),this.shape=e,this},hide:function(){return this.wrapper&&this.wrapper.hide(),this},show:function(){return this.wrapper&&this.wrapper.show(),this},toFront:function(){return this.wrapper&&this.wrapper.toFront(),this},toBack:function(){return this.wrapper&&this.wrapper.toBack(),this},toJSON:function(){return this.set("x",this.wrapper.x()),this.set("y",this.wrapper.y()),this._deepClone(this.attributes)}}),U=function(e,t,n,r,i){this.paper=e,this.point=t,this.angle=n,this.radians=r,this.attributes={},this.attributes.attr={};if(i){this.attributes.type=i.type;var s=Raphael._availableAttrs;for(var o in i)_.has(s,o)&&(this.get("attr")[o]=i[o])}return this};_.extend(U.prototype,t.Element.prototype),U.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},U.prototype.render=function(){var e=this.get("type");if(!e||e==="none")return this;var n;typeof t.arrows[e]=="function"?n=t.arrows[e](this.point):n=t.arrows.basic(this.point);var r=this.point.x+ -1.5*(n.dx-1)*Math.cos(this.radians),i=this.point.y+1.5*(n.dy-1)*Math.sin(this.radians);return this.wrapper=this.paper.path(n.path.join(" ")),this.wrapper.attr(n.attr),this.wrapper.attr(this.get("attr")),this.wrapper.translate(r,i),this.wrapper.rotate(this.angle),this};var z=t.ConnectionLabel=t.DiagramElement.extend({constructor:function(e){t.DiagramElement.apply(this,[e]);if(!e.connection)throw new Error("ConnectionLabel must have a parent Connection");this.connection=e.connection,this.diagram=this.connection.diagram,this.position=e.position,this.set("text",e.text)},remove:function(){this.wrapper&&this.wrapper.remove()},render:function(){this.remove();var e=this.paper(),t=this.connection,n=this.wrapper=e.text(0,0,this.get("text")),r=function(e,t,n,r){var i=t.xCenter<n,s=t.yMiddle>r,o=e.getBBox(),u=i?10+o.width/2:10-o.width,a=s?-10:10;return{x:n+u,y:r+a}},i=function(){var e=t.get("targetAnchor"),i=e.shape.bounds();abox=e.bounds(),x=abox.xCenter,y=abox.yMiddle;var s=Math.sqrt(x*x+y*y),o=Math.atan(y/x);return r(n,i,x,y)},s=function(){var e=t.get("sourceAnchor"),i=e.shape.bounds(),s=e.bounds(),o=s.xCenter,u=s.yMiddle;return r(n,i,o,u)},o=function(){var e=t.get("sourceAnchor"),n=t.get("targetAnchor"),r=e.bounds(),i=n.bounds(),s=r.xCenter,o=r.yMiddle,u=i.xCenter,a=i.yMiddle,f=(s+u)/2,l=(o+a)/2;return l-=10,{x:f,y:l}},u;switch(this.position){case"start":u=s();break;case"end":u=i();break;default:u=o()}return this.wrapper.transform(["t",u.x,",",u.y].join("")),this.asEditable().asDraggable(),this},setText:function(e){this.set("text",e),this.trigger("change:text",e),this.wrapper&&this.wrapper.attr("text",e)},asDraggable:function(){var e=function(){this.o()},t=function(){},n=function(e,t,n,r,i){var s=this.ox+e,o=this.oy+t;this.attr({x:s,y:o})};return this.wrapper&&(this.wrapper.attr({cursor:"move"}),this.wrapper.drag(n,e,t)),this},asEditable:function(){var e=this,t=this.connection.diagram;if(!e.wrapper)return;var n=function(e){var t=e.bounds(),n=e.connection.diagram,r=n.canvas().offsetLeft,i=n.canvas().offsetTop,s=t.x+(isNaN(r)?0:r),o=t.y+(isNaN(i)?0:i),u=t.width+20,a=20,f=document.createElement("form");f.setAttribute("style","position: absolute; left: "+s+"px; top: "+o+"px;");var l=document.createElement("input");return l.setAttribute("type","text"),l.setAttribute("placeholder",e.wrapper.attr("text")),l.setAttribute("style","padding: 0; width:"+u+"px; height: "+a+"px; z-index: 1;"),f.appendChild(l),{form:f,input:l}},r=function(e){e&&e.parentNode&&e.parentNode.removeChild(e)};return e.wrapper.dblclick(function(i){var s=t.modifiedLabel;s&&s!==e&&(r(t.inputText),r(t.modifiedLabel.textForm)),e.textForm&&r(e.textForm);var o=n(e);e.textForm=o.form,t.inputText=o.input,t.modifiedLabel=e,t.canvas().parentNode.appendChild(o.form)}),this}});W.prototype.render=function(){return this.remove(),this.wrapper=this.paper.rect(this.x-3,this.y-3,6,6,0),this.wrapper.attr({fill:"black",stroke:"none",cursor:"pointer"}),this.drag(),this.wrapper.toFront(),this},W.prototype.remove=function(){this.wrapper&&this.wrapper.remove()},W.prototype.drag=function(){if(!this.wrapper)return this;var e=this,t=this.connection,n=function(n,r){this.attr({x:this.ox+n,y:this.oy+r});var i=this.getABox();e.x=i.center.x,e.y=i.center.y,t.render()},r=function(){this.o(),e.state="dragging",this.attr("cursor","move")},i=function(){delete e.state,t.deselect()};this.wrapper.drag(n,r,i)};var X=t.Connection=t.DiagramElement.extend({toolbox:!0,constructor:function(e){t.DiagramElement.apply(this,[e]),this.set("sourceAnchor",new R({connection:this})),this.set("targetAnchor",new R({connection:this})),this.vertices=[],this.labels=[],this.toolbox&&(this._tool=new k({element:this})),this.diagram&&(this.diagram.get("edges").push(this),this.diagram.trigger("add:edges",this)),this.initialize.apply(this,arguments)},initialize:function(){},addPoint:function(e){var t=new W(this,e);return this.vertices.push(t),this.vertices=_.sortBy(this.vertices,function(e){return e.x}),this.render(),this},remove:function(e){return this.wrapper&&(this.unBindEvents(),this.wrapper.remove(),this.dummy.remove()),this.startArrow&&this.startArrow.remove(),this.endArrow&&this.endArrow.remove(),this._tool&&this._tool.remove(),this.labels&&_.each(this.labels,function(e){e.remove()}),_.each(this.vertices,function(e){e.state||e.remove()}),e&&(this.disconnect(),this.get("sourceAnchor").remove(),this.get("targetAnchor").remove(),this.diagram.removeConnection(this)),this.off("click",this._handleClick),this.off("dblclick",this._createFlexPoint),this},renderConnectionEnd:function(e,t){var n=this.paper(),i=e[0],s=e[1],o=t[0],u=t[1],a;this.vertices.length?a=r.theta(this.vertices[this.vertices.length-1],s.center):a=r.theta(i.center,s.center);var f=360-a.degrees+180,l=360-a.degrees;this.startArrow=new U(n,o,f,a.radians,this.start),this.endArrow=new U(n,u,l,a.radians,this.end),this.startArrow.render(),this.endArrow.render()},renderAnchors:function(e){var t=e[0],n=e[1];this.get("sourceAnchor").move(t).render().hide(),this.get("targetAnchor").move(n).render().hide()},createPath:function(){var e=V(this.get("sourceAnchor"),this.get("targetAnchor"),this.vertices,!1),t=this.paper();return this.wrapper=t.path(e.join(" ")),this.wrapper.attr(this.attributes),this.wrapper.controller=this,e},createEventPath:function(e){var t=this.paper();this.dummy=t.path(e.join(" ")),this.dummy.connection=this,this.dummy.attr({cursor:"pointer",fill:"none",opacity:0,"stroke-width":8})},_events:["click","dblclick","mouseover","mouseout"],bindEvents:function(){var e=this,t=this.dummy,n=function(t){return{eve:t,handler:function(n){e.trigger(t,n)}}},r=function(e){t[e.eve](e.handler)};this.eveHandlers=_.map(this._events,n),_.each(this.eveHandlers,r)},unBindEvents:function(){var e=this.dummy,t=function(t){e["un"+t.eve](t.handler)};_.each(this.eveHandlers,t),this.eveHandlers.length=0},render:function(){var e=this.getBoxes(),t=this.getPoints(e);return t.length!==2?this:(this.remove(),this.renderAnchors(t),this.createEventPath(this.createPath()),this.renderConnectionEnd(e,t),this.bindEvents(),this.on("click",this.showToolBox),this.on("click",this.select),this.on("dblclick",this.createFlexPoint),this.labels&&_.each(this.labels,function(e){e.render()}),this)},showToolBox:function(e){var t=this._tool,n=this.diagram;t&&t.render()},createFlexPoint:function(e){var t=r.get(this.diagram,e);this.addPoint(t),this.select()},select:function(){this.diagram.setSelection(this),this.get("sourceAnchor").toFront().show(),this.get("targetAnchor").toFront().show(),_.each(this.vertices,function(e){e.render()}),this.trigger("select")},deselect:function(){this.get("sourceAnchor").toFront().hide(),this.get("targetAnchor").toFront().hide(),_.each(this.vertices,function(e){e.remove()}),this.trigger("deselect")},connect:function(e,t){return!e||!t?this:(this.set("source",e),this.set("target",t),this.get("sourceAnchor").attach(e),this.get("targetAnchor").attach(t),e.trigger("connect:source",this),t.trigger("connect:target",this),this.trigger("connect"),e.outs.push(this),t.ins.push(this),this)},disconnect:function(){var e=this.get("source"),t=this.get("target");return e&&e.disconnect(this,"out"),t&&t.disconnect(this,"in"),this.set("source",null),this.set("target",null),this.trigger("disconnect"),this},connectByDragging:function(e,t){var n=this.diagram,i=n.paper(),s=this,o=this.dragger=this.get("targetAnchor"),u=r.get(i,t);this.set("source",e),this.get("sourceAnchor").attach(e),e.outs.push(this),this.state="dragging",this.dragger.move(u),this.dragger.render();var a=function(e){var t=r.get(i,e);o.move(t),s.render()},f=function(e){var t=o.getConnectableElement();t&&(o.establishConnection(t),n.off("mouseup",f),n.off("mousemove",a),n.wrapper.toBack())};n.wrapper.toFront(),n.on("mousemove",a),n.on("mouseup",f)},canConnect:function(e,t){return!0},toJSON:function(){var e={};return e.source=this.get("source").get("id"),e.target=this.get("target").get("id"),e.type=this.get("type"),e.id=this.get("id"),e.sourceAnchor=this.get("sourceAnchor"),e.targetAnchor=this.get("targetAnchor"),e.x=this.get("x"),e.y=this.get("y"),this.wrapper&&(e.attr=this.wrapper.attr()),e},getBoxes:function(){var e=this.paper(),t,n;return this.state==="dragging"?this.dragger===this.get("sourceAnchor")?(t=this.get("sourceAnchor").bounds(),n=this.get("target").bounds()):(t=this.get("source").bounds(),n=this.get("targetAnchor").bounds()):(t=this.get("source").bounds(),n=this.get("target").bounds()),[t,n]},getPoints:function(e){var t=this.paper(),n=e[0],s=e[1],o,u,a;return this.vertices.length?(o=new i(t,n.center,this.vertices[0]),u=o.findIntersection(n),o.remove(),o=new i(t,this.vertices[this.vertices.length-1],s.center),a=o.findIntersection(s),o.remove()):(o=new i(t,n.center,s.center),u=o.findIntersection(n),a=o.findIntersection(s),o.remove()),u||(u={x:n.xCenter,y:n.yMiddle}),a||(a={x:s.xCenter,y:s.yMiddle}),[new r(u),new r(a)]}});_.extend(t.Connection.prototype,t.Events)})(this);